<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>so retro</title>
  <link rel="icon" type="image/png" href="favicon.png">
<!-- im gonna intentionally leave this blank cause i dont wanna add font pointers lmao -->
  <style>
    /* ========================
       CUSTOM FONTS
       ======================== */
    @font-face {
      font-family: 'Bytesized';
      src: url('Bytesized-Regular.ttf') format('truetype');
      font-display: swap;
    }

    @font-face {
      font-family: 'Tiny5';
      src: url('Tiny5-Regular.ttf') format('truetype');
      font-display: swap;
    }

    @font-face {
      font-family: 'TomorrowLightItalic';
      src: url('Tomorrow-LightItalic.ttf') format('truetype');
      font-display: swap;
      font-style: italic;
      font-weight: 300;
    }

    /*
      ==========================================================================
      GLOBAL STYLES & LAYOUT
      ==========================================================================
    */
    :root {
      --blue-main: #245edb;
      --blue-dark: #0a246a;
      --xp-window-bg: #ece9d8;
      --xp-window-border-light: #fff;
      --xp-window-border-dark: #000;
      --start-menu-bg: #ece9d8;
      --start-menu-border: #7f7f7f;
      --green-start-hover: #316ac5;
      --red-turn-off: #b32a2a;
      --orange-logoff: #e69317;
      --xp-font-main: 'TomorrowLightItalic', 'Segoe UI', sans-serif;
      --xp-font-title: 'Tiny5', 'TomorrowLightItalic', sans-serif;
      --xp-font-small: 'TomorrowLightItalic', 'Segoe UI', sans-serif;
      --xp-font-tooltip: 'Bytesized', 'TomorrowLightItalic', sans-serif;
      --viewport-height: 100vh;
    }

    @supports (height: 100svh) {
      :root {
        --viewport-height: 100svh;
      }
    }

    @supports (height: 100dvh) {
      :root {
        --viewport-height: 100dvh;
      }
    }

    html, body {
      height: var(--viewport-height);
      min-height: var(--viewport-height);
      width: 100%;
      margin: 0;
      font-family: var(--xp-font-main);
      overflow: hidden;
      overscroll-behavior: none;
      background-color: #000;
      cursor: url('cursor.png'), auto;
      text-shadow: none;
      color: #000;
    }

    .desktop-icon:hover,
    #start-btn:hover,
    .taskbar-app-icon,
    .turn-off-btn,
    .window-button,
    .start-menu-entry,
    .logoff-shutdown-btn,
    .jukebox-controls button,
    #browser-content img,
    #clock,
    .minesweeper-reset,
    .user-tile {
      cursor: url('pointer.png'), pointer;
    }

    #journal-text-area {
      cursor: url('text.png'), text;
    }

    /*
      ==========================================================================
      LOGIN & SHUTDOWN SCREENS
      ==========================================================================
    */
    #login-screen, #shutdown-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: var(--viewport-height);
      min-height: var(--viewport-height);
      background-color: #000;
      color: #fff;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      transition: opacity 1s ease-in-out;
      z-index: 10000;
    }

    #login-screen.hidden {
      opacity: 0;
      pointer-events: none;
    }

    #login-hint {
      position: absolute;
      bottom: 12%;
      left: 50%;
      transform: translateX(-50%);
      width: clamp(220px, 80%, 620px);
      padding: 10px 18px;
      color: #fff;
      font-size: clamp(0.9rem, 2.6vw, 1.2rem);
      line-height: 1.5;
      letter-spacing: 0.02em;
      text-shadow: 0 0 10px rgba(0, 0, 0, 0.85);
      background: rgba(6, 6, 6, 0.55);
      border: 1px solid rgba(255, 255, 255, 0.25);
      border-radius: 10px;
      opacity: 0;
      transition: opacity 0.4s ease-in-out;
      pointer-events: none;
    }

    #login-hint.visible {
      opacity: 1;
    }

    .crt-effect {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
      background-size: 100% 2px, 3px 100%;
      pointer-events: none;
      opacity: 0.9;
      animation: flicker 0.1s infinite;
      z-index: 1;
    }

    @keyframes flicker {
        0%, 100% { opacity: 0.9; }
        25% { opacity: 0.8; }
        50% { opacity: 0.95; }
        75% { opacity: 0.85; }
    }

    /* Windows XP Welcome Screen Specific Styles */
    #login-welcome {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 18px;
        color: white;
        z-index: 1001;
        background: linear-gradient(180deg, #0d3da5 0%, #1958d5 45%, #0b2f7b 100%);
        padding: 40px 20px 30px;
    }

    #login-welcome::before {
        content: "";
        position: absolute;
        inset: 0;
        background:
            radial-gradient(circle at 25% 35%, rgba(255,255,255,0.18), transparent 55%),
            radial-gradient(circle at 80% 15%, rgba(255,255,255,0.15), transparent 55%);
        pointer-events: none;
        z-index: 0;
    }

    #login-welcome > * {
        position: relative;
        z-index: 1;
    }

    .login-frame {
        width: clamp(320px, calc(100vw - 40px), 960px);
        max-width: 960px;
        display: flex;
        flex-direction: column;
        border-radius: 22px;
        overflow: hidden;
        border: 2px solid rgba(255,255,255,0.35);
        box-shadow: 0 25px 60px rgba(0,0,0,0.45);
        backdrop-filter: blur(4px);
    }

    .login-shell {
        width: 100%;
        min-height: clamp(360px, 60vh, 520px);
        display: flex;
        border-radius: 0;
        overflow: hidden;
        background: linear-gradient(180deg, rgba(14, 79, 182, 0.6) 0%, rgba(79, 143, 233, 0.35) 100%);
    }

    .welcome-panel {
        flex: 0 0 40%;
        background: linear-gradient(180deg, #0e4fb6 0%, #1b6be0 45%, #4f8fe9 100%);
        color: #fff;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: flex-start;
        padding: 48px 36px;
        gap: 18px;
        position: relative;
    }

    .welcome-panel::after {
        content: "";
        position: absolute;
        inset: 0;
        background: radial-gradient(circle at 20% 20%, rgba(255,255,255,0.25), transparent 55%);
        pointer-events: none;
        z-index: 0;
    }

    .welcome-panel > * {
        position: relative;
        z-index: 1;
    }

    .xp-logo {
        display: grid;
        grid-template-columns: repeat(2, 18px);
        grid-gap: 3px;
    }

    .xp-logo span {
        width: 18px;
        height: 18px;
        border-radius: 2px;
    }

    .xp-logo .red { background:#d3302f; }
    .xp-logo .green { background:#2f9a1f; }
    .xp-logo .blue { background:#1a49d8; }
    .xp-logo .yellow { background:#f3c641; }

    .welcome-panel h1 {
        font-family: var(--xp-font-title);
        font-size: 46px;
        text-transform: uppercase;
        margin: 0;
        text-shadow: 2px 2px 0 rgba(0,0,0,0.35);
        letter-spacing: 0.08em;
    }

    .welcome-message {
        font-family: var(--xp-font-main);
        font-size: 16px;
        margin: 0;
        text-shadow: 1px 1px 0 rgba(0,0,0,0.25);
    }

    .user-panel {
        flex: 1;
        background: linear-gradient(180deg, rgba(255,255,255,0.92) 0%, rgba(223,231,255,0.85) 100%);
        display: flex;
        flex-direction: column;
        padding: 36px 32px;
        position: relative;
        color: #102b60;
    }

    .user-panel::after {
        content: "";
        position: absolute;
        inset: 0;
        border-left: 1px solid rgba(255,255,255,0.6);
        pointer-events: none;
        opacity: 0.5;
        z-index: 0;
    }

    .user-panel h2 {
        font-family: var(--xp-font-title);
        font-size: 24px;
        margin: 0 0 24px;
        text-transform: uppercase;
        text-shadow: 1px 1px 0 rgba(255,255,255,0.7);
        z-index: 1;
        position: relative;
    }

    .user-list {
        display: flex;
        flex-direction: column;
        gap: 18px;
        overflow-y: auto;
        padding-right: 6px;
        z-index: 1;
        position: relative;
    }

    .user-tile {
        display: flex;
        align-items: center;
        width: 100%;
        padding: 12px 16px;
        border-radius: 14px;
        border: 1px solid rgba(49,106,197,0.25);
        background: linear-gradient(180deg, rgba(255,255,255,0.85) 0%, rgba(198,213,246,0.8) 100%);
        box-shadow: inset 0 0 0 1px rgba(255,255,255,0.7);
        text-align: left;
        color: inherit;
        text-decoration: none;
        font-family: var(--xp-font-main);
        transition: transform 0.15s ease, box-shadow 0.15s ease, border-color 0.15s ease;
    }

    .user-tile:hover {
        border-color: rgba(49,106,197,0.8);
        box-shadow: inset 0 0 0 1px rgba(255,255,255,0.9), 0 8px 18px rgba(16,43,96,0.25);
        transform: translateX(4px);
    }

    .user-tile img {
        width: 56px;
        height: 56px;
        border-radius: 12px;
        margin-right: 16px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    .user-info {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .user-name {
        font-family: var(--xp-font-title);
        font-size: 20px;
        letter-spacing: 0.04em;
    }

    .user-sub {
        font-size: 13px;
        opacity: 0.85;
    }

    .login-footer {
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: linear-gradient(180deg, #0b3180 0%, #0a2c6a 100%);
        color: rgba(255,255,255,0.9);
        padding: 10px 24px;
        font-family: var(--xp-font-main);
        font-size: 12px;
        letter-spacing: 0.03em;
        border-top: 1px solid rgba(0, 0, 0, 0.35);
    }

    @media (max-width: 900px) {
        .login-frame {
            width: calc(100vw - 40px);
        }

        .login-shell {
            flex-direction: column;
            min-height: auto;
        }

        .welcome-panel,
        .user-panel {
            flex: 1 0 auto;
            width: 100%;
        }

        .welcome-panel {
            align-items: center;
            text-align: center;
            padding: 36px 28px;
        }

        .user-panel {
            align-items: center;
            text-align: center;
            padding: 28px 28px 36px;
        }

        .user-list {
            width: 100%;
            align-items: center;
        }

        .login-footer {
            flex-direction: column;
            gap: 12px;
            padding: 12px 24px 18px;
            text-align: center;
        }

        .turn-off-btn {
            order: -1;
        }
    }

    @media (max-width: 520px) {
        .login-frame {
            width: calc(100vw - 24px);
            border-radius: 18px;
        }

        .turn-off-btn {
            width: 100%;
            justify-content: center;
        }
    }

    @media (max-width: 768px) {
        html, body {
            height: 100%;
            min-height: 100svh;
        }

        #login-screen,
        #shutdown-screen,
        #desktop {
            min-height: 100svh;
        }
    }

    @media (max-width: 600px) {
    }

    .login-footer-text {
        opacity: 0.85;
    }

    .turn-off-btn {
        display: flex;
        align-items: center;
        background-color: #b32a2a;
        color: white;
        padding: 8px 15px;
        border: 1px solid #8e1e1e;
        border-radius: 5px;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        font-family: var(--xp-font-main);
        font-size: 14px;
        letter-spacing: 0.02em;
        transition: background-color 0.15s ease, box-shadow 0.15s ease;
    }
    
    .turn-off-btn img {
        width: 24px;
        height: 24px;
        margin-right: 8px;
    }

    .turn-off-btn:hover {
        background-color: #c63737;
        box-shadow: 0 3px 8px rgba(0,0,0,0.35);
    }

    /*
      ==========================================================================
      DESKTOP
      ==========================================================================
    */
    #desktop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: var(--viewport-height);
      min-height: var(--viewport-height);
      background: url('XP.png') no-repeat center center;
      background-size: cover;
      display: block;
      overflow: hidden;
      opacity: 0;
      transition: opacity 1s ease-in-out;
      z-index: 0;
    }

    #desktop.visible {
      opacity: 1;
    }
    
    .desktop-icon {
      position: absolute;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      margin: 10px;
      cursor: pointer;
      width: 80px;
      padding: 6px 4px;
      gap: 4px;
      border-radius: 6px;
      transition: background-color 0.1s ease-in-out;
      user-select: none;
    }

    .desktop-icon:hover {
      background-color: rgba(60, 120, 255, 0.45);
      border: 1px dashed rgba(255,255,255,0.7);
    }
    
    .desktop-icon img {
      width: 48px;
      height: 48px;
      pointer-events: none;
    }
    
    .desktop-icon span {
      color: white;
      text-shadow: 1px 1px 0 rgba(0,0,0,0.7), 0 0 3px rgba(255,255,255,0.6);
      font-size: 12px;
      font-family: var(--xp-font-main);
      pointer-events: none;
    }

    @media (min-width: 768px) {
      .desktop-icon {
        width: 108px;
        padding: 8px 6px 10px;
        gap: 6px;
      }
      .desktop-icon img {
        width: 64px;
        height: 64px;
      }
      .desktop-icon span {
        font-size: 14px;
      }
    }

    /*
      ==========================================================================
      TASKBAR
      ==========================================================================
    */
    #taskbar {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 28px;
      background: linear-gradient(to bottom, #7296da, #3457a4);
      border-top: 1px solid #102e60;
      display: flex;
      align-items: center;
      z-index: 500;
      padding: 0 5px;
      box-sizing: border-box;
    }
    
    .taskbar-top-lip {
      position: absolute;
      top: -2px;
      left: 0;
      width: 100%;
      height: 2px;
      background: linear-gradient(to right, #ffffff, #d8e5f2, #ffffff);
      opacity: 0.8;
    }

    #start-btn {
      width: 80px;
      height: 28px;
      border: 1px solid transparent;
      border-radius: 5px;
      cursor: pointer;
      position: relative;
      background: url('winxp.png') no-repeat center center;
      background-size: cover;
    }
    
    #start-btn:hover {
      background-color: rgba(255,255,255,0.2);
      box-shadow: 0 0 10px #fff;
    }

    #taskbar-apps {
      flex-grow: 1;
      display: flex;
      height: 100%;
      margin-left: 10px;
    }

    .taskbar-app-icon {
      background: linear-gradient(to top, #c4d7ed, #e6f0fa);
      border: 1px solid #003366;
      border-right: 1px solid #c4d7ed;
      border-bottom: 1px solid #c4d7ed;
      display: flex;
      align-items: center;
      padding: 2px 8px;
      margin: 2px 3px;
      cursor: pointer;
      font-size: 12px;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      max-width: 150px;
    }

    .taskbar-app-icon img {
      margin-right: 5px;
    }

    .taskbar-app-icon span {
      font-family: var(--xp-font-main);
      font-size: 12px;
      color: #0b2254;
      text-shadow: 1px 1px 0 rgba(255, 255, 255, 0.6);
    }
    
    .taskbar-app-icon.active {
      background: linear-gradient(to bottom, #c4d7ed, #e6f0fa);
      border-top: 1px solid #c4d7ed;
      border-left: 1px solid #c4d7ed;
      border-right: 1px solid #003366;
      border-bottom: 1px solid #003366;
    }

    .taskbar-app-icon.active span {
      color: #000;
    }

    #system-tray {
      display: flex;
      align-items: center;
      height: 100%;
      padding-right: 5px;
      border-left: 1px solid #102e60;
      background-color: #316ac5;
    }
    
    #notification-area {
      position: relative;
      margin-right: 10px;
      display: flex;
      align-items: center;
      height: 100%;
    }

    .notification {
      position: absolute;
      bottom: 28px;
      right: 5px;
      background-color: #fce899;
      border: 1px solid black;
      padding: 10px;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.5);
      font-size: 12px;
      width: 200px;
      display: flex;
      align-items: flex-start;
      gap: 10px;
      font-family: var(--xp-font-tooltip);
      letter-spacing: 0.02em;
      animation: fade-in-up 0.5s ease-out;
    }
    
    .notification img {
      width: 24px;
      height: 24px;
    }
    
    .notification.fade-out {
      animation: fade-out-down 0.5s ease-in forwards;
    }

    @keyframes fade-in-up {
      from { transform: translateY(100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    @keyframes fade-out-down {
      from { transform: translateY(0); opacity: 1; }
      to { transform: translateY(100%); opacity: 0; }
    }
    
    #system-tray .tray-icon {
      width: 16px;
      height: 16px;
      margin: 0 4px;
    }

    #clock {
      padding: 2px 5px;
      font-size: 11px;
      color: white;
      border: 1px solid #316ac5;
      background-color: #5587e6;
      border-radius: 3px;
      cursor: pointer;
      font-family: var(--xp-font-main);
      text-shadow: 1px 1px 0 rgba(0,0,0,0.6);
    }

    /* NEW: Calendar pop-up styles */
    #calendar-popup {
      position: absolute;
      bottom: 28px;
      right: 0;
      width: 280px;
      background-color: var(--xp-window-bg);
      border: 1px solid var(--xp-window-border-dark);
      box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
      border-radius: 5px;
      z-index: 501;
      display: none;
      padding: 10px;
      box-sizing: border-box;
      animation: fade-in-up 0.2s ease-out;
    }

    #calendar-popup.visible {
        display: block;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 1em;
      font-weight: bold;
      margin-bottom: 10px;
      border-bottom: 1px solid #ccc;
      padding-bottom: 5px;
    }

    .calendar-header button {
        background: none;
        border: 1px solid transparent;
        font-size: 1.2em;
        font-weight: bold;
        cursor: pointer;
    }

    .calendar-header button:hover {
        background-color: #d7e0f3;
    }

    #calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      text-align: center;
      font-size: 0.9em;
      gap: 5px;
    }

    .calendar-day-header {
      font-weight: bold;
    }

    .calendar-day {
      padding: 5px;
      border: 1px solid #ccc;
    }

    /*
      ==========================================================================
      START MENU
      ==========================================================================
    */
    #start-menu {
      position: absolute;
      bottom: 28px;
      left: 0;
      width: 300px;
      background-color: var(--start-menu-bg);
      border: 1px solid var(--start-menu-border);
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0,0,0,0.3);
      display: flex;
      z-index: 600;
      transform-origin: bottom left;
      animation: start-menu-open 0.2s ease-out;
    }
    
    @keyframes start-menu-open {
      from { transform: scale(0.1); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    #start-menu.hidden {
      display: none;
    }

    .start-menu-left-col {
      width: 150px;
      background: var(--blue-dark);
      border-radius: 10px 0 0 10px;
      padding: 10px 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      color: white;
    }

    .start-menu-user {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
    }

    .start-menu-user img {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: 2px solid white;
    }

    .start-menu-user span {
      margin-left: 10px;
      font-family: var(--xp-font-title);
      font-weight: bold;
    }

    .start-menu-entry {
      width: 95%;
      display: flex;
      align-items: center;
      padding: 5px;
      margin-bottom: 5px;
      border: 1px solid transparent;
      cursor: pointer;
      font-size: 13px;
      font-family: var(--xp-font-main);
      color: #000;
      text-shadow: 1px 1px 0 rgba(255,255,255,0.7);
    }
    
    .start-menu-entry:hover {
      background-color: var(--green-start-hover);
      color: white;
      border-color: #316ac5;
      text-shadow: none;
    }

    .start-menu-entry img {
      width: 20px;
      height: 20px;
      margin-right: 10px;
    }

    .start-menu-right-col {
      flex-grow: 1;
      padding: 10px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .start-menu-right-col .start-menu-entry {
      width: auto;
      margin-right: 0;
    }

    .start-menu-logoff-shutdown {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      padding-top: 10px;
      border-top: 1px solid #ccc;
    }

    .logoff-shutdown-btn {
      display: flex;
      align-items: center;
      padding: 5px 10px;
      border: 1px solid #aaa;
      border-radius: 5px;
      margin-left: 5px;
      cursor: pointer;
      font-size: 12px;
      font-family: var(--xp-font-main);
    }

    .logoff-shutdown-btn img {
      width: 20px;
      height: 20px;
      margin-right: 5px;
    }
    
    #logoff-btn {
      background-color: var(--orange-logoff);
      color: white;
      box-shadow: 0 0 10px var(--orange-logoff);
    }
    
    #logoff-btn:hover {
      box-shadow: 0 0 20px var(--orange-logoff);
    }

    #shutdown-btn {
      background-color: var(--red-turn-off);
      color: white;
      box-shadow: 0 0 10px var(--red-turn-off);
    }
    
    #shutdown-btn:hover {
      box-shadow: 0 0 20px var(--red-turn-off);
    }

    /*
      ==========================================================================
      WINDOWS
      ==========================================================================
    */
    .xp-window {
      position: absolute;
      background: linear-gradient(180deg, rgba(255,255,255,0.98) 0%, rgba(241,237,224,0.97) 52%, rgba(223,220,207,0.96) 100%);
      border-width: 1px 2px 2px 1px;
      border-style: solid;
      border-color: var(--xp-window-border-light) var(--xp-window-border-dark) var(--xp-window-border-dark) var(--xp-window-border-light);
      box-shadow: 2px 2px 6px rgba(0,0,0,0.25);
      border-radius: 5px;
      min-width: 200px;
      min-height: 100px;
      overflow: hidden;
      z-index: 10;
      animation: window-open 0.3s ease-out;
      font-family: var(--xp-font-main);
      transition: filter 0.2s ease, box-shadow 0.2s ease;
      max-width: calc(100vw - 24px);
      max-height: calc(100vh - 32px);
    }

    .xp-window:not(.active-window) {
      filter: saturate(0.85);
      box-shadow: 1px 1px 4px rgba(0,0,0,0.2);
    }

    #window-Jukebox {
        width: min(360px, calc(100vw - 24px));
        min-width: 240px;
    }

    @media (max-width: 600px) {
        #window-Jukebox {
            width: calc(100vw - 12px);
        }
    }

    /* UPDATED: Calculator styles */
    .calculator-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      grid-gap: 5px;
      padding: 10px;
      background-color: #c0c0c0;
      border: 2px outset #f0f0f0;
    }
    
    #calculator-display {
      grid-column: 1 / -1;
      background-color: #a4c5a4;
      border: 2px inset #5e7e5e;
      color: #000;
      font-family: monospace;
      font-size: 2em;
      text-align: right;
      padding: 5px;
      overflow: hidden;
    }

    .calc-btn {
      height: 40px;
      background-color: #e0e0e0;
      border: 2px outset #f0f0f0;
      font-size: 1.2em;
      cursor: pointer;
      text-shadow: 1px 1px #fff;
    }

    .calc-btn:active {
      border-style: inset;
    }
    
    .calc-btn.operator, .calc-btn.equals {
      background-color: #d1d1d1;
    }

    /* Minesweeper styles */
    .minesweeper-grid {
        display: grid;
        grid-template-columns: repeat(10, 25px);
        grid-template-rows: repeat(10, 25px);
        background-color: #c0c0c0;
        border: 2px inset #505050;
        margin: 0 auto;
    }

    .minesweeper-cell {
        width: 25px;
        height: 25px;
        background-color: #d0d0d0;
        border: 2px outset #f0f0f0;
        font-family: monospace;
        font-weight: bold;
        display: flex;
        justify-content: center;
        align-items: center;
        user-select: none;
        cursor: pointer;
        position: relative;
    }
    
    .minesweeper-cell.revealed {
        border-style: inset;
        background-color: #c0c0c0;
        cursor: default;
    }
    
    .minesweeper-cell.revealed img,
    .minesweeper-cell img {
        width: 20px;
        height: 20px;
    }
    
    .minesweeper-cell[data-mine] {
      background-color: #f00;
    }

    .minesweeper-cell.number-1 { color: #0300f8; }
    .minesweeper-cell.number-2 { color: #027d01; }
    .minesweeper-cell.number-3 { color: #fe0000; }
    .minesweeper-cell.number-4 { color: #000083; }
    .minesweeper-cell.number-5 { color: #830000; }
    .minesweeper-cell.number-6 { color: #008481; }
    .minesweeper-cell.number-7 { color: #830083; }
    .minesweeper-cell.number-8 { color: #000; }
    
    .minesweeper-wrapper {
        background-color: #bdbdbd;
        border: 4px outset #f0f0f0;
        padding: 6px;
        display: flex;
        flex-direction: column;
        gap: 6px;
        align-items: center;
    }

    .minesweeper-top {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background-color: #c0c0c0;
        border: 2px inset #ffffff;
        padding: 4px;
        width: 100%;
    }

    .minesweeper-counter {
        background-color: #000;
        color: #ff2a2a;
        font-family: var(--xp-font-title);
        font-size: 22px;
        line-height: 1;
        padding: 4px 8px;
        border: 2px inset #7f7f7f;
        min-width: 56px;
        text-align: center;
        text-shadow: 0 0 2px rgba(255, 42, 42, 0.6);
        letter-spacing: 0.1em;
    }

    .minesweeper-reset {
        width: 36px;
        height: 36px;
        border: 2px outset #ffffff;
        background-color: #c0c0c0;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: transform 0.1s ease;
        font-size: 0;
        position: relative;
    }

    .minesweeper-reset::after {
        content: attr(data-face-glyph);
        font-family: var(--xp-font-title);
        font-size: 18px;
        line-height: 1;
        color: #111;
        text-shadow: 0 1px 0 rgba(255,255,255,0.5);
    }

    .minesweeper-reset:active {
        border-style: inset;
        transform: translateY(1px);
    }

    .xp-window.closed {
      animation: window-close 0.3s ease-in forwards;
    }
    
    @keyframes window-open {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    
    @keyframes window-close {
      from { transform: scale(1); opacity: 1; }
      to { transform: scale(0.8); opacity: 0; }
    }
    
    .window-titlebar {
      height: 26px;
      background: linear-gradient(to right, #0a3aa2, #5a8de5);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 8px;
      cursor: move;
      color: #fff;
      font-family: var(--xp-font-title);
      font-weight: normal;
      text-shadow: 1px 1px 0 rgba(0, 0, 0, 0.6);
    }

    .window-titlebar span {
      font-size: 14px;
      letter-spacing: 0.02em;
    }

    .xp-window:not(.active-window) .window-titlebar {
      background: linear-gradient(to right, #5671a8, #9bb2d7);
      color: rgba(255,255,255,0.85);
      text-shadow: 1px 1px 0 rgba(0, 0, 0, 0.4);
    }

    .window-buttons {
      display: flex;
    }
    
    .window-button {
      width: 25px;
      height: 25px;
      background-color: #f0f0f0;
      border: 1px solid #7f7f7f;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .window-button img {
      width: 16px;
      height: 16px;
    }
    
    .window-button:hover {
      background-color: #d7e0f3;
    }

    .window-button.close:hover {
      background-color: #ff5454;
    }

    .window-content {
      padding: 10px;
      overflow-y: auto;
      overflow-x: hidden;
      height: calc(100% - 26px);
      max-height: calc(100% - 26px);
      box-sizing: border-box;
      background: linear-gradient(180deg, #ffffff 0%, #f6f3e7 100%);
      font-family: var(--xp-font-small);
      font-size: 13px;
      color: #111;
      line-height: 1.4;
    }
    
    .window-content img, .window-content iframe {
      display: block;
      margin: 0 auto;
      max-width: 100%;
    }

    #window-drag-preview {
      position: absolute;
      border: 2px dashed #333;
      pointer-events: none;
      z-index: 9999;
      display: none;
    }
    
    /* Jukebox Styles */
    #jukebox-content {
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 10px;
      font-size: 0.9rem;
      font-weight: bold;
      width: 100%;
    }

    .jukebox-song {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .jukebox-song > *:first-child {
      flex-shrink: 0;
    }

    .jukebox-song img {
      width: 84px;
      height: 84px;
      border-radius: 12px;
      object-fit: cover;
    }

    .jukebox-controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }

    .jukebox-controls button {
      min-width: 56px;
      height: 30px;
      padding: 0 12px;
      border-radius: 6px;
      border: 1px solid #3a6ea5;
      background: linear-gradient(to bottom, #fdfdff, #d1e3fa);
      color: #0b2254;
      font-size: 13px;
      font-family: var(--xp-font-main);
      cursor: pointer;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.6);
      transition: transform 0.1s ease, background 0.2s ease, box-shadow 0.2s ease;
    }

    .jukebox-controls button:hover {
      background: linear-gradient(to bottom, #e6f2ff, #b9d4fa);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.85), 0 0 8px rgba(58,110,165,0.3);
      transform: translateY(-1px);
    }
    
    .volume-container {
      width: 100%;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .volume-container input[type="range"] {
      flex: 1;
    }

    .jukebox-progress {
      width: 100%;
      display: flex;
      align-items: center;
      gap: 8px;
      font-family: var(--xp-font-small);
      font-size: 12px;
      color: #0b2254;
    }

    .jukebox-progress time {
      min-width: 44px;
      text-align: center;
      font-variant-numeric: tabular-nums;
    }

    #jukebox-seek {
      flex: 1;
      accent-color: #245edb;
      cursor: pointer;
    }

    .jukebox-options {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 12px;
      font-family: var(--xp-font-small);
      color: #0b2254;
      flex-wrap: wrap;
      justify-content: space-between;
    }

    .jukebox-options .option-group {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .loop-toggle, .jukebox-nav {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border: 1px solid rgba(58,110,165,0.6);
      border-radius: 6px;
      background: linear-gradient(180deg, rgba(255,255,255,0.9) 0%, rgba(200,220,250,0.8) 100%);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.75);
      cursor: pointer;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }

    .jukebox-action-btn {
      min-width: 68px;
      padding: 4px 10px;
      border-radius: 6px;
      border: 1px solid #3a6ea5;
      background: linear-gradient(to bottom, #fdfdff, #d1e3fa);
      color: #0b2254;
      font-family: var(--xp-font-main);
      font-size: 12px;
      cursor: pointer;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.7);
      transition: transform 0.1s ease, background 0.2s ease, box-shadow 0.2s ease;
    }

    .jukebox-action-btn:hover {
      background: linear-gradient(to bottom, #e6f2ff, #b9d4fa);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.85), 0 0 8px rgba(58,110,165,0.3);
      transform: translateY(-1px);
    }

    .loop-toggle.active {
      border-color: #245edb;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.9), 0 0 6px rgba(58,110,165,0.35);
    }

    #lyrics-panel {
      display: flex;
      flex-direction: column;
      gap: 6px;
      padding: 10px 12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.95) 0%, rgba(231,236,247,0.95) 100%);
      border: 2px inset #c5d4ed;
      border-radius: 8px;
      font-family: var(--xp-font-main);
      color: #0b2254;
    }

    .lyrics-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 8px;
    }

    .lyrics-header span:first-child {
      font-family: var(--xp-font-title);
      font-size: 16px;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    #lyrics-status {
      font-size: 11px;
      opacity: 0.7;
      font-family: var(--xp-font-small);
    }

    #lyrics-scroll {
      position: relative;
      max-height: 160px;
      overflow-y: auto;
      overflow-x: hidden;
      background: rgba(255,255,255,0.9);
      border: 1px solid #9db5e2;
      border-radius: 6px;
      padding: 6px 8px;
      box-shadow: inset 0 1px 4px rgba(11,34,84,0.15);
    }

    #lyrics-lines {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .lyrics-line {
      padding: 4px 6px;
      border-radius: 4px;
      transition: background-color 0.2s ease, color 0.2s ease;
      line-height: 1.35;
      font-size: 13px;
      color: #122a56;
    }

    .lyrics-line[data-section] {
      font-family: var(--xp-font-title);
      font-size: 12px;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      opacity: 0.75;
    }

    .lyrics-line.active {
      background: linear-gradient(90deg, rgba(49,106,197,0.35) 0%, rgba(93,142,228,0.55) 100%);
      color: #fff;
      text-shadow: 0 1px 1px rgba(0,0,0,0.25);
    }

    .lyrics-line[data-muted="true"] {
      opacity: 0.6;
      font-style: italic;
    }

    .lyrics-empty {
      margin: 12px 0 6px;
      text-align: center;
      font-size: 12px;
      color: #455a96;
      display: none;
    }

    #lyrics-panel[data-state="empty"] .lyrics-empty {
      display: block;
    }

    #lyrics-panel[data-state="empty"] #lyrics-lines {
      display: none;
    }

    #lyrics-panel[data-mode="compact"] #lyrics-scroll {
      max-height: none;
      overflow-y: hidden;
    }

    .lyrics-disclaimer {
      margin-top: 6px;
      padding: 10px 12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.95) 0%, rgba(231,236,247,0.95) 100%);
      border: 1px solid #9db5e2;
      border-radius: 8px;
      font-family: var(--xp-font-small);
      font-size: 12px;
      color: #0b2254;
      line-height: 1.45;
      box-shadow: inset 0 1px 2px rgba(11,34,84,0.12);
    }

    .lyrics-disclaimer strong {
      display: block;
      font-family: var(--xp-font-title);
      letter-spacing: 0.05em;
      margin-bottom: 6px;
      text-transform: uppercase;
    }

    .lyrics-disclaimer p {
      margin: 0 0 6px;
    }

    /* UPDATED: Browser styles */
    .browser-toolbar {
        background-color: #f1f1f1;
        border-bottom: 2px solid #ccc;
        padding: 5px;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .browser-toolbar button {
        width: 24px;
        height: 24px;
        background-color: #e0e0e0;
        border: 1px outset #fff;
        font-size: 14px;
    }

    .browser-toolbar button:active {
        border-style: inset;
    }

    .url-bar {
        flex-grow: 1;
        padding: 2px 5px;
        border: 1px inset #ccc;
        background-color: #fff;
        font-size: 12px;
    }
    
    #browser-content {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 10px;
      padding: 10px;
      overflow-y: auto;
    }
    
    #browser-content img {
      width: 100%;
      height: auto;
      cursor: pointer;
    }

    /* "You Are An Idiot" Virus Window Styles */
    .idiot-window {
      position: absolute;
      width: 300px;
      height: 200px;
      background-color: black;
      color: white;
      border: 2px solid white;
      overflow: hidden;
      z-index: 900;
      text-align: center;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .idiot-window-content {
      font-size: 24px;
      font-weight: bold;
      animation: color-flash 0.5s infinite;
    }
    
    @keyframes color-flash {
      0%, 100% { color: white; background: black; }
      50% { color: black; background: white; }
    }
    
  </style>
</head>
<body>

  <div id="login-screen">
    <div id="login-welcome">
      <div class="login-frame">
        <div class="login-shell">
          <div class="welcome-panel">
            <div class="xp-logo">
              <span class="red"></span>
              <span class="green"></span>
              <span class="blue"></span>
              <span class="yellow"></span>
            </div>
            <h1>welcome</h1>
            <p class="welcome-message">Click your user name to begin.</p>
          </div>
          <div class="user-panel">
            <h2>select a user</h2>
            <div class="user-list">
              <button class="user-tile" onclick="attemptLogin(); clickSound.play();">
                <img src="alex.png" alt="alex">
                <div class="user-info">
                  <span class="user-name">alex</span>
                  <span class="user-sub">Type your password</span>
                </div>
              </button>
            </div>
          </div>
        </div>
        <div class="login-footer">
          <button class="turn-off-btn" onclick="shutdownSequence(); clickSound.play();">
            <img src="13.png" alt="Turn Off">
            Turn Off Computer
          </button>
          <span class="login-footer-text">To add or change accounts go to Control Panel.</span>
        </div>
      </div>
    </div>
    <div id="login-hint" role="status" aria-live="polite" aria-hidden="true">
      Hint: Double tap the desktop icons to open them, and press the toolbar windows at the bottom of the screen to easily minimize tabs.
    </div>
  </div>

  <div id="shutdown-screen" style="display: none;">
    <p style="font-size: 2em;">Shutting down...</p>
  </div>

  <div id="desktop">
    <div class="crt-effect"></div>

    <div class="desktop-icon" data-title="Bio" style="top: 20px; left: 20px;">
      <img src="1.png" alt="Bio">
      <span>Bio</span>
    </div>
    <div class="desktop-icon" data-title="Interests" style="top: 120px; left: 20px;">
      <img src="2.png" alt="Interests">
      <span>Interests</span>
    </div>
    <div class="desktop-icon" data-title="DNI" style="top: 220px; left: 20px;">
      <img src="3.png" alt="DNI">
      <span>DNI</span>
    </div>
    <div class="desktop-icon" data-title="Journal" style="top: 320px; left: 20px;">
      <img src="4.png" alt="Journal">
      <span>Journal</span>
    </div>
    <div class="desktop-icon" data-title="Drawings" style="top: 20px; left: 120px;">
      <img src="5.png" alt="Drawings">
      <span>Drawings</span>
    </div>
    <div class="desktop-icon" data-title="Games" style="top: 120px; left: 120px;">
      <img src="6.png" alt="Games">
      <span>Games</span>
    </div>
    <div class="desktop-icon" data-title="My Computer" style="top: 220px; left: 120px;">
      <img src="8.png" alt="My Computer">
      <span>My Computer</span>
    </div>
    <div class="desktop-icon" data-title="Recycle Bin" style="top: 320px; left: 120px;">
      <img src="7.png" alt="Recycle Bin">
      <span>Recycle Bin</span>
    </div>
    <div class="desktop-icon" data-title="Calculator" style="top: 20px; left: 220px;">
        <img src="calculator.png" alt="Calculator">
        <span>Calculator</span>
    </div>
    <div class="desktop-icon" data-title="Minesweeper" style="top: 120px; left: 220px;">
        <img src="minesweeper.png" alt="Minesweeper">
        <span>Minesweeper</span>
    </div>
  </div>

  <div id="taskbar">
    <div class="taskbar-top-lip"></div>
    <button id="start-btn" onclick="toggleStartMenu(); clickSound.play();"></button>
    <div id="taskbar-apps"></div>
    <div id="system-tray">
      <div id="notification-area"></div>
      <div id="clock"></div>
    </div>
  </div>

  <div id="calendar-popup">
      <div class="calendar-header">
        <button onclick="changeMonth(-1);">&#9664;</button>
        <span id="calendar-title"></span>
        <button onclick="changeMonth(1);">&#9654;</button>
      </div>
      <div id="calendar-grid"></div>
  </div>

  <div id="start-menu" class="hidden">
    <div class="start-menu-left-col">
      <div class="start-menu-user">
        <img src="alex.png" alt="User">
        <span>alex</span>
      </div>
      <div class="start-menu-entries">
        <div class="start-menu-entry" onclick="openWindow('Bio', 1); toggleStartMenu(); clickSound.play();">
          <img src="1.png" alt="Bio">
          <span>Bio</span>
        </div>
        <div class="start-menu-entry" onclick="openWindow('Interests', 2); toggleStartMenu(); clickSound.play();">
          <img src="2.png" alt="Interests">
          <span>Interests</span>
        </div>
        <div class="start-menu-entry" onclick="openWindow('DNI', 3); toggleStartMenu(); clickSound.play();">
          <img src="3.png" alt="DNI">
          <span>DNI</span>
        </div>
        <div class="start-menu-entry" onclick="openWindow('Journal', 4); toggleStartMenu(); clickSound.play();">
          <img src="4.png" alt="Journal">
          <span>Journal</span>
        </div>
        <div class="start-menu-entry" onclick="openWindow('Drawings', 5); toggleStartMenu(); clickSound.play();">
          <img src="5.png" alt="Drawings">
          <span>Drawings</span>
        </div>
        <div class="start-menu-entry" onclick="openWindow('Games', 6); toggleStartMenu(); clickSound.play();">
          <img src="6.png" alt="Games">
          <span>Games</span>
        </div>
      </div>
    </div>
    <div class="start-menu-right-col">
      <div>
        <div class="start-menu-entry" onclick="openWindow('My Computer', 8); toggleStartMenu(); clickSound.play();">
          <img src="8.png" alt="My Computer">
          <span>My Computer</span>
        </div>
        <div class="start-menu-entry" onclick="openWindow('Jukebox', 10, Math.max(12, window.innerWidth / 2 - 160), Math.max(32, window.innerHeight / 3 - 120)); toggleStartMenu(); clickSound.play();">
          <img src="10.png" alt="Jukebox">
          <span>Jukebox</span>
        </div>
        <div class="start-menu-entry" onclick="openWindow('Browser', 12); toggleStartMenu(); clickSound.play();">
          <img src="12.png" alt="Browser">
          <span>Browser</span>
        </div>
        <div class="start-menu-entry" onclick="openWindow('Calculator', 'calculator'); toggleStartMenu(); clickSound.play();">
            <img src="calculator.png" alt="Calculator">
            <span>Calculator</span>
        </div>
        <div class="start-menu-entry" onclick="openWindow('Minesweeper', 'minesweeper'); toggleStartMenu(); clickSound.play();">
            <img src="minesweeper.png" alt="Minesweeper">
            <span>Minesweeper</span>
        </div>
      </div>
      <div class="start-menu-logoff-shutdown">
        <button id="logoff-btn" class="logoff-shutdown-btn" onclick="logOff(); clickSound.play();">
          <img src="14.png" alt="Log Off">
          Log Off
        </button>
        <button id="shutdown-btn" class="logoff-shutdown-btn" onclick="shutdownSequence(); clickSound.play();">
          <img src="13.png" alt="Shutdown">
          Turn Off Computer
        </button>
      </div>
    </div>
  </div>

  <div id="window-drag-preview"></div>

  <audio id="bg-music"></audio>
  <audio id="startup-sound" src="XPstartup.mp3"></audio>
  <audio id="shutdown-sound" src="XPshutdown.mp3"></audio>
  <audio id="notification-sound" src="notif.mp3"></audio>

  <script>
    /*
      ==========================================================================
      JAVASCRIPT LOGIC
      ==========================================================================
    */

    // --- Core UI elements ---
    const loginScreen = document.getElementById('login-screen');
    const loginWelcome = document.getElementById('login-welcome');
    const loginHint = document.getElementById('login-hint');
    const desktop = document.getElementById('desktop');
    const shutdownScreen = document.getElementById('shutdown-screen');
    const startMenu = document.getElementById('start-menu');
    const taskbarApps = document.getElementById('taskbar-apps');
    const clock = document.getElementById('clock');
    const dragPreview = document.getElementById('window-drag-preview');
    const crtOverlay = document.querySelector('.crt-effect');
    
    // NEW: Calendar elements
    const calendarPopup = document.getElementById('calendar-popup');
    const calendarTitle = document.getElementById('calendar-title');
    const calendarGrid = document.getElementById('calendar-grid');

    // Calendar state
    let currentCalendarDate = new Date();
    let crtEnabled = true;

    // --- Audio Elements ---
    const jukeboxAudio = document.getElementById('bg-music');
    let jukeboxBaseVolume = 0.35;
    let currentSongVolumeMultiplier = 1;
    jukeboxAudio.volume = jukeboxBaseVolume;
    const startupSound = new Audio('XPstartup.mp3');
    const shutdownSound = new Audio('XPshutdown.mp3');
    const clickSound = new Audio('open.mp3');
    const notificationSound = document.getElementById('notification-sound');
    let awaitingAudioUnlock = false;
    let autoplayNoticeShown = false;

    // --- Easter Egg Messages ---
    const easterEggs = [
        "wait, hold on, i can edit these?",
        "windows xp was a kinda fun operating system.",
        "did you know a single floppy disk could only hold 1.44 MB?",
        "time to add the 90th dial up sound to make it 9000 millionths more retro!",
        "if you're reading this, you just found an easter egg! :egg: :retro_egg: :egg:",
        "'This whole project was made with the help of a very helpful AI.' - gemini & chatgpt, ty for help!",
        "ooooooooooooooooouuuuuggggghhhhh",
        "GITHUB developer CAUGHT using .WEBP files?!",
        "the computer says NO.",
        "hi saur :smile:",
        "LOVE-LETTER-FOR-YOU.TXT.vbs received in email!",
        "don't worry, the BSOD is just a feature.",
        "Warning: RETRO SLUDGE AHEAD.",
        "'wow, its barely buggy!' i say, with my large bug shaped belly.",
        "dial up reference no. 4",
        "don't forget to defragment your hard drive for optimal performance!",
        "you've been using your computer for a while. maybe it's time to take a break?",
        "you see Spawn! by evan fong? that guy is actually vanossgaming ðŸ˜­",
        "im probably not putting THIS much effort into the other sites, i love favouritism!",
        "dont worry, as long as its in the recycle bin, its trashed, right?",
        "Kindly check the attached love letter from me! ~ LOVE-LETTER-FOR-YOU.TXT.vbs"
    ];

    // --- State variables ---
    let openWindows = {};
    let zIndexCounter = 100;

    // --- Jukebox songs data ---
    const songs = [
      { file: "Music1.mp3", credit: "Spawn! - Evan Fong", icon: "Music1.jpg", lyricsId: "spawn" },
      { file: "Music2.mp3", credit: "Vapor Buster - Deltarune Chapter 3 + 4 - Toby Fox", icon: "Music2.jpg" },
      { file: "Music3.mp3", credit: "Fireplace - Deltarune Chapter 3 + 4 - Toby Fox", icon: "Music3.jpg" },
      { file: "Music4.mp3", credit: "Air Waves - Deltarune Chapter 3 + 4 - Toby Fox", icon: "Music4.jpg" },
      { file: "Music5.mp3", credit: "Home Sweet Grave - Arc System Works - GUILTY GEAR SOUND COMPLETE BOX (7)", icon: "Music5.jpg" },
      { file: "Music6.mp3", credit: "Don't Preheat your Oven Because if you do the Song Won't Play - Pizza Tower", icon: "Music6.jpg" },
      { file: "Music7.mp3", credit: "BLOODY STREAM - JJBA", icon: "Music7.jpg", lyricsId: "bloodyStream", volumeMultiplier: 0.5 },
      { file: "Music8.mp3", credit: "growing on me - snayk", icon: "Music8.jpg" },
      { file: "Music9.mp3", credit: "Friday Theme - uglyburger0", icon: "Music9.jpg" },
      { file: "Music10.mp3", credit: "Great Days - JJBA", icon: "Music10.jpg", lyricsId: "greatDays" },
      { file: "Music11.mp3", credit: "Red Sun - METAL GEAR RISING: REVENGEANCE", icon: "Music11.jpg", lyricsId: "redSun" },
      { file: "Music12.mp3", credit: "Famine (Pursuer Jason) || FORSAKEN OST", icon: "MISSING.png" }
    ];
    let currentSongIndex = 0;

    const jukeboxControls = {
      elements: null,
      isSeeking: false
    };
    const SECRET_SEQUENCE = ['x', 'p', '!'];
    let secretSequenceProgress = 0;

    const lyricsLibrary = {
      spawn: {
        note: "Auto-synced (approx.)",
        cues: [
          { section: "Intro" },
          { time: 3.8, text: "Kapooya!" },
          { time: 12.7, text: "One, two, three, four!" },
          { section: "Verse 1" },
          { time: 43, text: "(In my bed)", muted: true },
          { time: 46, text: "(Counting stars on my ceiling)", muted: true },
          { time: 48.4, text: "(Before I paint it red)", muted: true },
          { time: 53, text: "(In my mess)", muted: true },
          { time: 55, text: "(Spawn a new face on my head)", muted: true },
          { time: 58, text: "(I will not regret)", muted: true },
          { time: 62.5, text: "In my bed (my bed, my bed)" },
          { time: 65, text: "Counting stars on my ceiling (ceiling, ceiling)" },
          { time: 67.4, text: "Before I paint it red (paint it red)" },
          { time: 72, text: "In my mess (my mess, my mess)" },
          { time: 74, text: "Spawn a new face on my head (my head, my head)" },
          { time: 77, text: "I will not regret (regret, regret)" },
          { section: "Chorus" },
          { time: 80.6, text: "When I feel lost" },
          { time: 84, text: "Man, I swear to God, I don't feel my brain" },
          { time: 87.3, text: "Last chance, I won't be coming back" },
          { time: 94.8, text: "Will they understand, understand?" },
          { section: "Verse 2" },
          { time: 100.8, text: "Back again (back again)" },
          { time: 103, text: "Project Mayhem, evil friend (evil friend)" },
          { time: 106, text: "Solace in the end (the end)" },
          { time: 110, text: "Smoke some Reds (smoke some Reds)" },
          { time: 112.3, text: "Spawn a new face on my head (my head)" },
          { time: 113.2, text: "I will not regret (regret)" },
          { section: "Chorus" },
          { time: 117.9, text: "When I feel lost" },
          { time: 122.7, text: "Man, I swear to God, I don't feel my brain" },
          { time: 128, text: "Last chance, I won't be coming back" },
          { time: 133, text: "Will they understand, understand?" },
          { time: 138, text: "When I feel lost" },
          { time: 142, text: "Man, I swear to God, I don't feel my brain" },
          { time: 147, text: "Last chance, I won't be coming back" },
          { time: 152, text: "Will they understand, understand? (Understand)" },
          { section: "Hook" },
          { time: 157.0, text: "In my bed (understand)" },
          { time: 158.5, text: "I lose my breath (understand)" },
          { time: 160.0, text: "Should I eject? (Understand)" },
          { time: 161.5, text: "And lay to rest (understand)" },
          { time: 163.0, text: "In my bed (understand)" },
          { time: 164.5, text: "I lose my breath (understand)" },
          { time: 166.0, text: "Should I eject? (Understand)" },
          { time: 167.5, text: "And lay to rest (understand)" },
          { section: "Outro" },
          { time: 177.0, text: "In my mess (understand)" },
          { time: 180.0, text: "Spawn a new face on my head" },
          { time: 183.0, text: "I will not regret" },
          { time: 186.0, text: "When I feel lost" },
        ]
      },
      bloodyStream: {
        note: "[Lyrics Unavailable]",
        cues: [
          { section: "[Lyrics Unavailable]" },
          { time: 0, text: "[Lyrics Unavailable]" }
        ]
      },
      greatDays: {
        note: "[Lyrics Unavailable]",
        cues: [
          { section: "[Lyrics Unavailable]" },
          { time: 0, text: "[Lyrics Unavailable]" }
        ]
      },
      redSun: {
        note: "[Lyrics Unavailable]",
        cues: [
          { section: "[Lyrics Unavailable]" },
          { time: 0, text: "[Lyrics Unavailable]" }
        ]
      }
    };

    const LYRICS_SYNC_LEEWAY = 0.35;

    const lyricsState = {
      cues: [],
      currentIndex: -1,
      pending: null,
      songFile: null,
      ui: null
    };

    // --- App content data ---
    const windowContent = {
      'Bio': `<p>hi, thanks for opening my page and stuff,,,,,</p><p>im alex, 16 (feb 21, 2009) soooo uhhh yea. this website is a personal project to practice my HTML, CSS, and JavaScript with the help of openai and gemini cause im batshit stupid,</p><p>i might add some more stuff here some other time, but for now i hope you like it.</p><p>but this was a site i made as a replacement straw page for my friends :)</p><p>contact:</p><p>discord: im.notalex</p><p>roblox: midnightmesa</p><p>x: toomanyalexs</p><p>i hope you like the site though, im working with my other friends to get theirs setup then yall will be able to interact with it 👅</p><p>ill update this when my friends are finished their site, currently riley is working on his and im helping saur with hers, so eventually they'll be done and temkky, hoodie and valks will be done aswell :)</p><p>ill probably add some other friends aswell :P</p></div>`,
      'Interests': `<div class="window-entry"><p>i like playing games, especially sandbox and pvp games. i also enjoy drawing and programming. i listen to music and stuff, or call my girlfriend cause shes sweet</p><p>IM DEVELOPING A GAME COME BACK LATER PLS!!!</div>`,
      'DNI': `<p>if you are older than me by about ~3-5 ish years dont expect me to be super comfortable around you unless i know you (unless you're my goat retro being 34 years older than me bro!!)</p><p>but i also dont like heavy racist stuff (stupid instagram reels are ok cause I send them ((im just such a nice hypocritical guy)</p><p>also adult people in general make me uncomfortable if i dont know them (cause obviously im not 16 talking to a 25 year old brotato chip)</p><p>and im a huge g(j)ermaphobe and i hate anything like blood, mucus, etc. it just makes me a little uneasy but i wont like scream from it.</p><p>yes, even i have parameters im comfortable with, you FUCKS</p><p>aka the rodents that saw ts and was picking at me for it, you're getting FELT up tonight BUDDY.</p></div>`,
      'Journal': `<textarea id="journal-text-area" placeholder="wait i forgot this is a input area not a text area, oopsies"></textarea>`,
      'Drawings': `<p>heres some stuff i draw/drew</p><img src="15.png" alt="Drawing 1"><img src="16.png" alt="Drawing 2">`,
      'Games': `<p>i play these games:</p><ul><li>roblox</li><li>minecraft</li><li>terraria (sometimes)</li><li>stardew valley</li><li>ultrakill</li><li>gow:r</li><li>any multiplayer sandbox game pretty much.</li></ul><p>i don't play these games:</p><ul><li>fortnite</li><li>cod</li><li>overwatch</li><li>valorant</li><li>practically any fps game that is massively multiplayer, i dont play. maybe fort though</li></ul><p>things i frequent:</p><ul><li>roblox</li><li>discord</li></ul>`,
      'My Computer': `<p>i forgot to put something here, uh ohhhh.... (what would i put here anyways?)</p>`,
      'Recycle Bin': `<p>guys, awesome bin here, i cant wait to make a rm -rf /* joke on a windows os!</p>`,
      'Browser': `
        <div class="browser-toolbar">
            <img src="browser.png" style="width: 16px; height: 16px;">
            <button>&larr;</button>
            <button>&rarr;</button>
            <button>&#8635;</button>
            <input type="text" class="url-bar" value="https://alanisagooner.chud" readonly>
        </div>
        <div id="browser-content">
          <img src="skull.gif" alt="skull" onclick="triggerIdiotVirus()">
        </div>
      `,
      'Jukebox': `
        <div id="jukebox-content">
          <div class="jukebox-song">
            <img id="song-icon" src="Music1.jpg" alt="Song artwork">
            <div id="song-info" aria-live="polite">Loading...</div>
          </div>
          <div class="jukebox-controls">
            <button class="jukebox-nav" onclick="prevSong(); clickSound.play();">&laquo;</button>
            <button class="jukebox-nav" onclick="nextSong(); clickSound.play();">&raquo;</button>
          </div>
          <div class="volume-container">
            <label for="volume">Volume</label>
            <input id="volume" type="range" min="0" max="1" step="0.01" value="0.35">
          </div>
          <div class="jukebox-progress">
            <time id="jukebox-current-time">0:00</time>
            <input id="jukebox-seek" type="range" min="0" max="0" step="0.1" value="0" disabled>
            <time id="jukebox-duration">0:00</time>
          </div>
          <div class="jukebox-options">
            <div class="option-group">
              <label class="loop-toggle" id="jukebox-loop-toggle">
                <input type="checkbox" id="jukebox-loop">
                <span>Loop track</span>
              </label>
            </div>
            <div class="option-group">
              <button type="button" class="jukebox-action-btn" id="jukebox-play">Start</button>
              <button type="button" class="jukebox-action-btn" id="jukebox-stop">Stop</button>
              <button type="button" class="jukebox-action-btn" id="lyrics-disclaimer-toggle" aria-expanded="false">Copyright notice</button>
            </div>
          </div>
          <div id="lyrics-disclaimer-panel" class="lyrics-disclaimer" hidden>
            <strong>Copyright Notice &amp; Disclaimer</strong>
            <p>This project includes references to the song &quot;Spawn!&quot; by Evan Fong (Vanoss), and possibly other copyrighted musical works.</p>
            <p>All lyrics, compositions, and recordings are the intellectual property of their respective copyright holders.</p>
            <p>No ownership of the original music, lyrics, or artwork is claimed by the project author. All referenced material is used for demonstration, educational, or fan purposes only, and no revenue is generated from its use.</p>
            <p>This repository does NOT distribute or host any copyrighted audio, nor does it seek to replace, monetize, or compete with the original work. It is hosted, however it is NOT monetized or permitted for download off this repository.</p>
            <p>If you are a rights holder and believe any portion of this project violates your rights, please contact me directly for removal or modification.</p>
            <p>&copy; Evan Fong / Vanoss &amp; respective rights holders. All rights reserved. Project maintained by im.notalex.</p>
          </div>
          <div id="lyrics-panel" data-state="loading">
            <div class="lyrics-header">
              <span>Lyrics</span>
              <span id="lyrics-status">Loading...</span>
            </div>
            <div id="lyrics-scroll">
              <ul id="lyrics-lines"></ul>
              <p class="lyrics-empty">Lyrics not available for this track.</p>
            </div>
          </div>
        </div>
      `,
      'XP Tips': `
        <div class="window-entry">
          <p>Hidden tricks for wandering XP explorers:</p>
          <ul>
            <li><strong>Ctrl&nbsp;+&nbsp;Alt&nbsp;+&nbsp;C</strong> toggles the CRT bloom overlay.</li>
            <li>Tap <strong>X &rarr; P &rarr; !</strong> to surface this secret again.</li>
            <li>Use the jukebox <em>Start</em>/<em>Stop</em> buttons to quickly audition a track without leaving the window.</li>
          </ul>
          <p>Now shoo.</p>
        </div>
      `,
      'Calculator': `
        <div class="calculator-grid" id="calculator-grid">
            <div id="calculator-display">0</div>
            <button class="calc-btn" onclick="handleCalculatorInput('C');">C</button>
            <button class="calc-btn operator" onclick="handleCalculatorInput('/');">÷</button>
            <button class="calc-btn operator" onclick="handleCalculatorInput('*');">×</button>
            <button class="calc-btn operator" onclick="handleCalculatorInput('-');">-</button>
            <button class="calc-btn" onclick="handleCalculatorInput('7');">7</button>
            <button class="calc-btn" onclick="handleCalculatorInput('8');">8</button>
            <button class="calc-btn" onclick="handleCalculatorInput('9');">9</button>
            <button class="calc-btn operator" onclick="handleCalculatorInput('+');">+</button>
            <button class="calc-btn" onclick="handleCalculatorInput('4');">4</button>
            <button class="calc-btn" onclick="handleCalculatorInput('5');">5</button>
            <button class="calc-btn" onclick="handleCalculatorInput('6');">6</button>
            <button class="calc-btn equals" onclick="handleCalculatorInput('=');">=</button>
            <button class="calc-btn" onclick="handleCalculatorInput('1');">1</button>
            <button class="calc-btn" onclick="handleCalculatorInput('2');">2</button>
            <button class="calc-btn" onclick="handleCalculatorInput('3');">3</button>
            <button class="calc-btn" onclick="handleCalculatorInput('0');">0</button>
            <button class="calc-btn" onclick="handleCalculatorInput('.');">.</button>
        </div>
      `,
      'Minesweeper': `
        <div class="minesweeper-wrapper">
          <div class="minesweeper-top">
            <div class="minesweeper-counter" id="minesweeper-mine-counter">000</div>
            <button class="minesweeper-reset" id="minesweeper-reset-button" data-face="neutral" data-face-glyph=":)" title="Reset game" aria-label="Reset game" onclick="resetMinesweeper(); clickSound.play();">:)</button>
            <div class="minesweeper-counter" id="minesweeper-timer">000</div>
          </div>
          <div class="minesweeper-grid" id="minesweeper-grid"></div>
        </div>
      `
    };

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
      updateClock();
      setInterval(updateClock, 1000);
      startMenu.classList.add('hidden');
      setupDesktopIcons();
      document.getElementById('clock').addEventListener('click', toggleCalendar);
      
      // Start the random notification loop
      setTimeout(showRandomEasterEgg, 5000);
    });

    // --- Login & Shutdown logic ---
    function attemptLogin() {
      loginWelcome.style.opacity = '0';
      if (loginHint) {
        loginHint.classList.add('visible');
        loginHint.setAttribute('aria-hidden', 'false');
      }
      startupSound.play().catch(e => console.error("Startup sound failed:", e));;
      setTimeout(() => {
        loginScreen.classList.add('hidden');
        desktop.classList.add('visible');
        const viewportWidth = window.innerWidth || document.documentElement.clientWidth || 360;
        const viewportHeight = window.innerHeight || document.documentElement.clientHeight || 640;
        const isCompactViewport = window.matchMedia
          ? window.matchMedia('(max-width: 600px)').matches
          : viewportWidth <= 600;
        const jukeboxWidth = isCompactViewport
          ? Math.max(240, viewportWidth - 12)
          : Math.max(240, Math.min(360, viewportWidth - 24));
        const startX = Math.max(12, Math.round((viewportWidth - jukeboxWidth) / 2));
        const estimatedHeight = isCompactViewport ? 460 : 340;
        const maxTop = Math.max(32, viewportHeight - estimatedHeight - 16);
        const preferredTop = viewportHeight * 0.22;
        const startY = Math.max(32, Math.min(maxTop, preferredTop));
        openWindow('Jukebox', 10, startX, startY); 
        if (loginHint) {
          loginHint.classList.remove('visible');
          loginHint.setAttribute('aria-hidden', 'true');
        }
      }, 4500);
    }

    function shutdownSequence() {
      loginScreen.style.opacity = '0';
      shutdownScreen.style.display = 'flex';
      shutdownSound.play().catch(e => console.error("Shutdown sound failed:", e));
      setTimeout(() => {
        window.location.href = 'https://boogerboys.github.io/index.html';
      }, 5000);
    }

    function logOff() {
      window.location.reload();
    }
    
    // --- Taskbar & Start Menu logic ---
    function updateClock() {
      const now = new Date();
      const time = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
      const date = now.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
      clock.textContent = `${time} ${date}`;
    }

    // UPDATED: Calendar logic
    function toggleCalendar() {
        calendarPopup.classList.toggle('visible');
        if (calendarPopup.classList.contains('visible')) {
            renderCalendar();
        }
    }

    function renderCalendar() {
        calendarGrid.innerHTML = '';
        const year = currentCalendarDate.getFullYear();
        const month = currentCalendarDate.getMonth();
        const monthName = currentCalendarDate.toLocaleString('en-US', { month: 'long' });

        calendarTitle.textContent = `${monthName} ${year}`;
        
        const firstDayOfMonth = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        dayNames.forEach(day => {
            const dayHeader = document.createElement('div');
            dayHeader.className = 'calendar-day-header';
            dayHeader.textContent = day;
            calendarGrid.appendChild(dayHeader);
        });

        for (let i = 0; i < firstDayOfMonth; i++) {
            calendarGrid.appendChild(document.createElement('div'));
        }

        for (let i = 1; i <= daysInMonth; i++) {
            const dayEl = document.createElement('div');
            dayEl.className = 'calendar-day';
            dayEl.textContent = i;
            if (i === new Date().getDate() && month === new Date().getMonth() && year === new Date().getFullYear()) {
                dayEl.style.fontWeight = 'bold';
                dayEl.style.backgroundColor = '#d7e0f3';
            }
            calendarGrid.appendChild(dayEl);
        }
    }

    function changeMonth(delta) {
        currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
        renderCalendar();
    }

    function toggleStartMenu() {
      startMenu.classList.toggle('hidden');
    }

    // --- Notification Logic ---
    function announceDesktopMessage(message) {
      const notificationArea = document.getElementById('notification-area');
      if (!notificationArea) return;
      const notification = document.createElement('div');
      notification.className = 'notification';
      notification.innerHTML = `<img src="11.png" alt="Notification"><p>${message}</p>`;
      notificationArea.appendChild(notification);
      
      notificationSound.play();

      // Remove after 5 seconds with a fade-out
      setTimeout(() => {
        notification.classList.add('fade-out');
        setTimeout(() => {
          notification.remove();
        }, 500);
      }, 5000);
    }
    
    function showEasterEgg() {
      const randomMessage = easterEggs[Math.floor(Math.random() * easterEggs.length)];
      announceDesktopMessage(randomMessage);
    }
    
    function setCRTEnabled(enabled, silent = false) {
      crtEnabled = enabled;
      if (crtOverlay) {
        crtOverlay.style.display = enabled ? 'block' : 'none';
      }
      document.body.classList.toggle('crt-disabled', !enabled);
      if (!silent) {
        announceDesktopMessage(enabled ? 'CRT bloom enabled.' : 'CRT bloom disabled.');
      }
    }

    function toggleCRT(force) {
      const targetState = typeof force === 'boolean' ? force : !crtEnabled;
      setCRTEnabled(targetState);
    }
    
    setCRTEnabled(true, true);

    function constrainWindowToViewport(win) {
      if (!win) return;
      const rect = win.getBoundingClientRect();
      const desiredLeft = parseFloat(win.style.left) || rect.left;
      const desiredTop = parseFloat(win.style.top) || rect.top;
      const maxLeft = Math.max(8, window.innerWidth - rect.width - 8);
      const maxTop = Math.max(32, window.innerHeight - rect.height - 16);
      const clampedLeft = Math.min(Math.max(desiredLeft, 8), maxLeft);
      const clampedTop = Math.min(Math.max(desiredTop, 32), maxTop);
      win.style.left = `${clampedLeft}px`;
      win.style.top = `${clampedTop}px`;
    }

    function handleViewportResize() {
      Object.values(openWindows).forEach(win => {
        if (!win) return;
        constrainWindowToViewport(win);
      });
    }
    
    window.addEventListener('resize', handleViewportResize);
    
    function getSongVolumeMultiplier(song) {
      if (!song) return 1;
      return typeof song.volumeMultiplier === 'number' ? song.volumeMultiplier : 1;
    }

    function applySongVolume(updateSlider = false) {
      const actualVolume = Math.max(0, Math.min(1, jukeboxBaseVolume * currentSongVolumeMultiplier));
      jukeboxAudio.volume = actualVolume;
      if (!updateSlider) return;
      const controls = getJukeboxControls();
      if (controls && controls.volume && document.activeElement !== controls.volume) {
        controls.volume.value = jukeboxBaseVolume;
      }
    }
    
    function showRandomEasterEgg() {
      showEasterEgg();
      const randomInterval = Math.random() * (120000 - 30000) + 30000;
      setTimeout(showRandomEasterEgg, randomInterval);
    }

    // --- Window logic ---
    function openWindow(title, iconNumber, initialX = 50, initialY = 50) {
      if (openWindows[title]) {
        const existing = openWindows[title];
        existing.style.display = 'block';
        bringToFront(existing);
        return;
      }
      
      zIndexCounter++;
      const win = document.createElement('div');
      win.className = 'xp-window active-window';
      win.style.left = `${initialX}px`;
      win.style.top = `${initialY}px`;
      win.style.zIndex = zIndexCounter;
      win.id = `window-${title.replace(/\s/g, '-')}`;

      const taskbarIcon = document.createElement('button');
      taskbarIcon.className = 'taskbar-app-icon active';
      taskbarIcon.innerHTML = `<img src="${iconNumber}.png" style="width: 16px; height: 16px;"><span>${title}</span>`;
      taskbarIcon.onclick = () => {
        if (win.style.display === 'none') {
          win.style.display = 'block';
          bringToFront(win);
        } else if (win.style.zIndex != zIndexCounter) {
          bringToFront(win);
        } else {
          win.style.display = 'none';
          taskbarIcon.classList.remove('active');
        }
      };
      taskbarApps.appendChild(taskbarIcon);
      win.taskbarIcon = taskbarIcon;
      
      const windowHtml = `
        <div class="window-titlebar">
          <span>${title}</span>
          <div class="window-buttons">
            <button class="window-button" onclick="minimizeWindow(this.parentNode.parentNode.parentNode); clickSound.play();">
              <img src="minimize.png">
            </button>
            <button class="window-button close" onclick="closeWindow(this.parentNode.parentNode.parentNode); clickSound.play();">
              <img src="close.png">
            </button>
          </div>
        </div>
        <div class="window-content">
          ${windowContent[title] || `<p>Content for ${title} is missing.</p>`}
        </div>
      `;
      win.innerHTML = windowHtml;
      desktop.appendChild(win);
      openWindows[title] = win;
      bringToFront(win);
      constrainWindowToViewport(win);

      win.addEventListener('mousedown', (e) => {
        if (!e.target.closest('.window-content') || e.target.closest('.window-titlebar')) {
          bringToFront(win);
        }
      });

      if (title === 'Jukebox') {
        setupJukeboxWindow(win);
        playSong(Math.floor(Math.random() * songs.length), { notifyOnBlock: true });
      } else if (title === 'Minesweeper') {
        initializeMinesweeper();
      }
    }

    function closeWindow(win) {
      const title = win.id.replace('window-', '').replace(/-/g, ' ');
      win.classList.add('closed');
      win.classList.remove('active-window');
      if (win.taskbarIcon) win.taskbarIcon.remove();
      delete openWindows[title];
      
      if (title === 'Jukebox') {
          stopCurrentTrack(true);
          resetLyricsUI();
          lyricsState.ui = null;
          jukeboxControls.elements = null;
          jukeboxControls.isSeeking = false;
      } else if (title === 'Minesweeper') {
          stopMinesweeperTimer();
      }
      
      setTimeout(() => {
        if (win.parentNode) win.parentNode.removeChild(win);
      }, 300);
    }

    function minimizeWindow(win) {
      win.style.display = 'none';
      win.classList.remove('active-window');
      if (win.taskbarIcon) win.taskbarIcon.classList.remove('active');
    }

    function bringToFront(win) {
      zIndexCounter++;
      win.style.zIndex = zIndexCounter;
      Object.values(openWindows).forEach(w => {
          if (!w) return;
          w.classList.remove('active-window');
          if (w.taskbarIcon) w.taskbarIcon.classList.remove('active');
      });
      win.classList.add('active-window');
      if (win.taskbarIcon) win.taskbarIcon.classList.add('active');
    }

    // --- Window Drag logic ---
    let activeWindow = null;
    let offsetX, offsetY;

    function dragStart(e, win) {
      if (e.target.closest('.window-titlebar')) {
        activeWindow = win;
        bringToFront(activeWindow);
        offsetX = e.clientX - win.offsetLeft;
        offsetY = e.clientY - win.offsetTop;
        
        dragPreview.style.display = 'block';
        dragPreview.style.width = win.offsetWidth + 'px';
        dragPreview.style.height = win.offsetHeight + 'px';
        dragPreview.style.left = win.offsetLeft + 'px';
        dragPreview.style.top = win.offsetTop + 'px';

        activeWindow.style.opacity = '0.5';
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', dragEnd);
      }
    }

    function drag(e) {
      if (activeWindow) {
        const newX = e.clientX - offsetX;
        const newY = e.clientY - offsetY;
        dragPreview.style.left = newX + 'px';
        dragPreview.style.top = newY + 'px';
      }
    }

    function dragEnd() {
      if (activeWindow) {
        const newX = parseInt(dragPreview.style.left, 10);
        const newY = parseInt(dragPreview.style.top, 10);
        
        activeWindow.style.left = newX + 'px';
        activeWindow.style.top = newY + 'px';
        activeWindow.style.opacity = '1';
        constrainWindowToViewport(activeWindow);
        
        dragPreview.style.display = 'none';
        activeWindow = null;
        document.removeEventListener('mousemove', drag);
        document.removeEventListener('mouseup', dragEnd);
      }
    }
    
    // --- Desktop Icon Drag Logic ---
    let activeIcon = null;

    function setupDesktopIcons() {
      const icons = document.querySelectorAll('.desktop-icon');
      icons.forEach(icon => {
        icon.addEventListener('mousedown', (e) => {
          activeIcon = icon;
          offsetX = e.clientX - icon.offsetLeft;
          offsetY = e.clientY - icon.offsetTop;
          document.addEventListener('mousemove', dragIcon);
          document.addEventListener('mouseup', stopDragIcon);
          e.preventDefault();
        });
        icon.addEventListener('dblclick', () => {
          const title = icon.dataset.title;
          let iconSrc = icon.querySelector('img').src;
          let iconNumber = iconSrc.split('/').pop().replace('.png', '');
          openWindow(title, iconNumber);
          clickSound.play();
        });
      });
    }

    function dragIcon(e) {
      if (activeIcon) {
        let x = e.clientX - offsetX;
        let y = e.clientY - offsetY;
        
        x = Math.max(0, Math.min(x, desktop.clientWidth - activeIcon.clientWidth));
        y = Math.max(0, Math.min(y, desktop.clientHeight - activeIcon.clientHeight - 28));

        activeIcon.style.left = x + 'px';
        activeIcon.style.top = y + 'px';
      }
    }
    
    function stopDragIcon() {
      activeIcon = null;
      document.removeEventListener('mousemove', dragIcon);
      document.removeEventListener('mouseup', stopDragIcon);
    }
    
    // --- Jukebox Logic ---
    jukeboxAudio.addEventListener("ended", nextSong);
    jukeboxAudio.addEventListener("timeupdate", () => {
        syncLyricsToTime(jukeboxAudio.currentTime);
        updatePlaybackTimeUI();
    });
    jukeboxAudio.addEventListener("seeked", () => {
        syncLyricsToTime(jukeboxAudio.currentTime);
        updatePlaybackTimeUI(true);
    });
    jukeboxAudio.addEventListener("loadedmetadata", handleAudioMetadata);
    jukeboxAudio.addEventListener("durationchange", () => updatePlaybackTimeUI(true));
    jukeboxAudio.addEventListener("play", () => {
        awaitingAudioUnlock = false;
        autoplayNoticeShown = false;
    });

    function attemptJukeboxPlayback(options = {}) {
        const notifyOnBlock = !!options.notifyOnBlock;
        const playAttempt = jukeboxAudio.play();
        if (!playAttempt || typeof playAttempt.catch !== 'function') {
            return;
        }
        playAttempt.then(() => {
            awaitingAudioUnlock = false;
        }).catch((error) => {
            if (notifyOnBlock && isAutoplayBlock(error)) {
                handleAutoplayBlock();
            } else {
                console.error("Audio playback failed:", error);
            }
        });
    }

    function isAutoplayBlock(error) {
        if (!error) return false;
        return error.name === 'NotAllowedError' || error.name === 'SecurityError' || error.name === 'NotSupportedError';
    }

    function handleAutoplayBlock() {
        if (!autoplayNoticeShown) {
            announceDesktopMessage('Browser blocked the jukebox autoplay. Press Start in the jukebox window to enable sound.');
            autoplayNoticeShown = true;
        }
        armAudioUnlock();
    }

    function armAudioUnlock() {
        if (awaitingAudioUnlock) return;
        awaitingAudioUnlock = true;
        const unlock = () => {
            document.removeEventListener('pointerdown', unlock);
            document.removeEventListener('keydown', unlock);
            awaitingAudioUnlock = false;
            attemptJukeboxPlayback({ notifyOnBlock: false });
        };
        document.addEventListener('pointerdown', unlock);
        document.addEventListener('keydown', unlock);
    }

    function playSong(index, options = {}) {
        currentSongIndex = index;
        const song = songs[index];
        jukeboxAudio.src = song.file;
        attemptJukeboxPlayback({ notifyOnBlock: !!options.notifyOnBlock });

        const songInfoEl = document.getElementById("song-info");
        const songIconEl = document.getElementById("song-icon");

        if (songInfoEl) songInfoEl.textContent = song.credit;
        if (songIconEl) {
            songIconEl.src = song.icon || 'Music1.jpg';
            songIconEl.alt = `Artwork for ${song.credit}`;
        }

        currentSongVolumeMultiplier = getSongVolumeMultiplier(song);
        applySongVolume(true);

        jukeboxControls.isSeeking = false;
        updatePlaybackTimeUI(true);
        const controls = getJukeboxControls();
        if (controls) {
            if (controls.seek) {
                controls.seek.disabled = !Number.isFinite(jukeboxAudio.duration);
                controls.seek.value = 0;
            }
            if (controls.loopToggle) {
                controls.loopToggle.checked = jukeboxAudio.loop;
                setLoopIndicator(jukeboxAudio.loop);
            }
            if (controls.volume && document.activeElement !== controls.volume) {
                controls.volume.value = jukeboxBaseVolume;
            }
        }

        updateLyricsForSong(song);
    }

    function nextSong() {
        let next = (currentSongIndex + 1) % songs.length;
        playSong(next);
    }

    function prevSong() {
        let prev = (currentSongIndex - 1 + songs.length) % songs.length;
        playSong(prev);
    }
    
    function getLyricsUI() {
        if (lyricsState.ui && document.body.contains(lyricsState.ui.panel)) {
            return lyricsState.ui;
        }
        const panel = document.getElementById('lyrics-panel');
        if (!panel) {
            lyricsState.ui = null;
            return null;
        }
        lyricsState.ui = {
            panel,
            status: document.getElementById('lyrics-status'),
            list: document.getElementById('lyrics-lines'),
            scroll: document.getElementById('lyrics-scroll')
        };
        return lyricsState.ui;
    }

    function resetLyricsUI() {
        lyricsState.cues = [];
        lyricsState.currentIndex = -1;
        lyricsState.pending = null;
        lyricsState.songFile = null;
        closeDisclaimerPanel();
        const ui = getLyricsUI();
        if (!ui) {
            lyricsState.ui = null;
            return;
        }
        if (ui.list) {
            ui.list.innerHTML = '';
        }
        ui.panel.dataset.state = 'loading';
        ui.panel.dataset.mode = 'compact';
        if (ui.status) {
            ui.status.textContent = 'Lyrics will appear when a compatible song plays.';
        }
    }

    function getJukeboxControls(forceRefresh = false) {
        if (!forceRefresh && jukeboxControls.elements && jukeboxControls.elements.seek && document.body.contains(jukeboxControls.elements.seek)) {
            return jukeboxControls.elements;
        }

        const seek = document.getElementById('jukebox-seek');
        if (!seek) {
            jukeboxControls.elements = null;
            return null;
        }

        jukeboxControls.elements = {
            seek,
            current: document.getElementById('jukebox-current-time'),
            duration: document.getElementById('jukebox-duration'),
            loopToggle: document.getElementById('jukebox-loop'),
            loopLabel: document.getElementById('jukebox-loop-toggle'),
            volume: document.getElementById('volume')
        };
        return jukeboxControls.elements;
    }

    function setLoopIndicator(isOn) {
        const controls = getJukeboxControls();
        if (!controls || !controls.loopLabel) return;
        controls.loopLabel.classList.toggle('active', !!isOn);
    }

    function getDisclaimerElements() {
        return {
            panel: document.getElementById('lyrics-disclaimer-panel'),
            button: document.getElementById('lyrics-disclaimer-toggle')
        };
    }

    function toggleDisclaimerPanel(forceShow) {
        const { panel, button } = getDisclaimerElements();
        if (!panel || !button) return;
        const currentlyHidden = panel.hasAttribute('hidden');
        const shouldShow = typeof forceShow === 'boolean' ? forceShow : currentlyHidden;
        if (typeof forceShow === 'undefined') {
            clickSound.play();
        }
        if (shouldShow) {
            panel.removeAttribute('hidden');
        } else {
            panel.setAttribute('hidden', '');
        }
        button.setAttribute('aria-expanded', shouldShow ? 'true' : 'false');
        button.textContent = shouldShow ? 'Hide notice' : 'Copyright notice';
    }

    function closeDisclaimerPanel() {
        const { panel, button } = getDisclaimerElements();
        if (!panel || !button) return;
        panel.setAttribute('hidden', '');
        button.setAttribute('aria-expanded', 'false');
        button.textContent = 'Copyright notice';
    }

    function stopCurrentTrack(resetPosition = false) {
        jukeboxAudio.pause();
        jukeboxControls.isSeeking = false;
        if (resetPosition) {
            jukeboxAudio.currentTime = 0;
            syncLyricsToTime(0);
            updatePlaybackTimeUI(true);
            closeDisclaimerPanel();
        } else {
            syncLyricsToTime(jukeboxAudio.currentTime);
            updatePlaybackTimeUI();
        }
        applySongVolume(true);
    }

    function setupJukeboxWindow(win) {
        const controls = getJukeboxControls(true);
        if (!controls) return;
        jukeboxControls.isSeeking = false;

        if (controls.volume) {
            controls.volume.value = jukeboxBaseVolume;
            controls.volume.addEventListener('input', () => {
                const nextValue = parseFloat(controls.volume.value);
                if (Number.isFinite(nextValue)) {
                    jukeboxBaseVolume = Math.max(0, Math.min(1, nextValue));
                    applySongVolume();
                }
            });
            applySongVolume(true);
        }

        const playBtn = document.getElementById('jukebox-play');
        if (playBtn) {
            playBtn.onclick = () => {
                clickSound.play();
                attemptJukeboxPlayback();
            };
        }

        const stopBtn = document.getElementById('jukebox-stop');
        if (stopBtn) {
            stopBtn.onclick = () => {
                clickSound.play();
                stopCurrentTrack(false);
            };
        }

        const disclaimerBtn = document.getElementById('lyrics-disclaimer-toggle');
        if (disclaimerBtn) {
            disclaimerBtn.onclick = () => toggleDisclaimerPanel();
        }
        closeDisclaimerPanel();

        const seek = controls.seek;
        if (seek) {
            seek.min = 0;
            seek.value = jukeboxAudio.currentTime || 0;
            seek.disabled = !Number.isFinite(jukeboxAudio.duration);
            seek.addEventListener('input', handleSeekInput);
            seek.addEventListener('change', commitSeek);
            ['pointerdown', 'mousedown', 'touchstart'].forEach(evt => {
                seek.addEventListener(evt, () => { jukeboxControls.isSeeking = true; });
            });
            ['pointerup', 'mouseup', 'touchend', 'touchcancel', 'pointercancel'].forEach(evt => {
                seek.addEventListener(evt, commitSeek);
            });
        }

        if (controls.loopToggle) {
            controls.loopToggle.checked = jukeboxAudio.loop;
            jukeboxAudio.loop = controls.loopToggle.checked;
            controls.loopToggle.addEventListener('change', () => {
                jukeboxAudio.loop = controls.loopToggle.checked;
                setLoopIndicator(controls.loopToggle.checked);
            });
            setLoopIndicator(controls.loopToggle.checked);
        }

        updatePlaybackTimeUI(true);
    }

    function handleSeekInput() {
        const controls = getJukeboxControls();
        if (!controls || !controls.seek) return;
        const value = parseFloat(controls.seek.value);
        if (!Number.isFinite(value)) return;
        jukeboxControls.isSeeking = true;
        if (controls.current) {
            controls.current.textContent = formatTime(value);
        }
        if (Number.isFinite(jukeboxAudio.duration) && jukeboxAudio.duration > 0) {
            jukeboxAudio.currentTime = Math.min(Math.max(value, 0), jukeboxAudio.duration);
            syncLyricsToTime(jukeboxAudio.currentTime);
        }
    }

    function commitSeek() {
        const controls = getJukeboxControls();
        if (!controls || !controls.seek) {
            jukeboxControls.isSeeking = false;
            return;
        }
        const value = parseFloat(controls.seek.value);
        if (Number.isFinite(value)) {
            const duration = Number.isFinite(jukeboxAudio.duration) && jukeboxAudio.duration > 0 ? jukeboxAudio.duration : value;
            const clamped = Math.min(Math.max(value, 0), duration);
            jukeboxAudio.currentTime = clamped;
            syncLyricsToTime(clamped);
        }
        jukeboxControls.isSeeking = false;
        updatePlaybackTimeUI(true);
    }

    function formatTime(seconds) {
        if (!Number.isFinite(seconds) || seconds < 0) seconds = 0;
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function updatePlaybackTimeUI(force = false) {
        const controls = getJukeboxControls();
        if (!controls) return;
        const duration = Number.isFinite(jukeboxAudio.duration) && jukeboxAudio.duration > 0 ? jukeboxAudio.duration : 0;
        const current = Number.isFinite(jukeboxAudio.currentTime) && jukeboxAudio.currentTime > 0 ? jukeboxAudio.currentTime : 0;

        if (controls.duration) {
            controls.duration.textContent = duration ? formatTime(duration) : '--:--';
        }

        if (controls.seek) {
            controls.seek.min = 0;
            if (duration > 0) {
                controls.seek.disabled = false;
                controls.seek.max = duration;
                controls.seek.step = Math.max(duration / 1200, 0.05);
                if (!jukeboxControls.isSeeking || force) {
                    controls.seek.value = current;
                }
            } else {
                controls.seek.disabled = true;
                controls.seek.value = 0;
            }
        }

        if (controls.current && (!jukeboxControls.isSeeking || force)) {
            controls.current.textContent = formatTime(current);
        }
    }

    function updateLyricsForSong(song) {
        const ui = getLyricsUI();
        lyricsState.songFile = song.file;
        lyricsState.cues = [];
        lyricsState.pending = null;
        setActiveLyricsIndex(-1);
        if (!ui) {
            return;
        }
        closeDisclaimerPanel();
        ui.panel.dataset.mode = 'full';
        if (ui.list) {
            ui.list.innerHTML = '';
        }
        if (!song.lyricsId || !lyricsLibrary[song.lyricsId]) {
            ui.panel.dataset.state = 'empty';
            ui.panel.dataset.mode = 'compact';
            if (ui.status) {
                ui.status.textContent = 'Lyrics unavailable for this track.';
            }
            lyricsState.pending = null;
            return;
        }
        const entry = lyricsLibrary[song.lyricsId];
        const duration = Number.isFinite(jukeboxAudio.duration) ? jukeboxAudio.duration : 0;
        const needsDuration = entry.cues.some(cue => typeof cue.fraction === 'number');

        ui.panel.dataset.state = 'loading';
        if (ui.status) {
            ui.status.textContent = 'Syncing lyrics...';
        }

        if (needsDuration && duration <= 0) {
            lyricsState.pending = { entry, songFile: song.file };
            ui.panel.dataset.mode = entry.cues.length <= 4 ? 'compact' : 'full';
            return;
        }

        renderLyrics(entry, duration);
        lyricsState.pending = null;
    }

    function renderLyrics(entry, duration) {
        const ui = getLyricsUI();
        if (!ui || !ui.list) return;
        ui.list.innerHTML = '';
        lyricsState.cues = [];
        lyricsState.currentIndex = -1;

        const safeDuration = Number.isFinite(duration) && duration > 0 ? duration : 0;
        const upperClamp = safeDuration > 0 ? Math.max(safeDuration - 0.2, safeDuration * 0.95) : 0;

        entry.cues.forEach(item => {
            if (item.section) {
                const sectionEl = document.createElement('li');
                sectionEl.className = 'lyrics-line';
                sectionEl.dataset.section = 'true';
                sectionEl.textContent = item.section;
                ui.list.appendChild(sectionEl);
                return;
            }

            const lineEl = document.createElement('li');
            lineEl.className = 'lyrics-line';
            if (item.muted) {
                lineEl.dataset.muted = 'true';
            }
            lineEl.textContent = item.text;

            let cueTime = 0;
            if (typeof item.time === 'number') {
                cueTime = item.time;
            } else if (typeof item.fraction === 'number' && safeDuration > 0) {
                cueTime = item.fraction * safeDuration;
            }

            if (safeDuration > 0) {
                cueTime = Math.min(Math.max(cueTime, 0), upperClamp);
            } else {
                cueTime = Math.max(cueTime, 0);
            }

            lineEl.dataset.time = cueTime.toFixed(3);
            lyricsState.cues.push({ time: cueTime, element: lineEl });
            ui.list.appendChild(lineEl);
        });

        if (lyricsState.cues.length) {
            lyricsState.cues.sort((a, b) => a.time - b.time);
            ui.panel.dataset.state = 'ready';
            ui.panel.dataset.mode = lyricsState.cues.length <= 4 ? 'compact' : 'full';
        } else {
            ui.panel.dataset.state = 'empty';
            ui.panel.dataset.mode = 'compact';
        }

        if (ui.status) {
            ui.status.textContent = entry.note || 'Synced lyrics';
        }

        syncLyricsToTime(jukeboxAudio.currentTime);
    }

    function handleAudioMetadata() {
        updatePlaybackTimeUI(true);
        const song = songs[currentSongIndex];
        if (!song) return;
        applySongVolume(true);
        if (lyricsState.pending && song.file === lyricsState.pending.songFile) {
            renderLyrics(lyricsState.pending.entry, jukeboxAudio.duration);
            lyricsState.pending = null;
        }
        syncLyricsToTime(jukeboxAudio.currentTime);
    }

    function syncLyricsToTime(currentTime) {
        if (!lyricsState.cues.length) {
            if (lyricsState.currentIndex !== -1) {
                setActiveLyricsIndex(-1);
            }
            return;
        }

        let nextIndex = -1;
        for (let i = lyricsState.cues.length - 1; i >= 0; i--) {
            const cueTime = Number(lyricsState.cues[i].time ?? 0);
            if (currentTime + LYRICS_SYNC_LEEWAY >= cueTime) {
                nextIndex = i;
                break;
            }
        }

        if (nextIndex !== lyricsState.currentIndex) {
            setActiveLyricsIndex(nextIndex);
        }
    }

    function setActiveLyricsIndex(index) {
        const ui = getLyricsUI();
        if (!ui || !ui.list) return;

        if (lyricsState.currentIndex >= 0 && lyricsState.cues[lyricsState.currentIndex]) {
            lyricsState.cues[lyricsState.currentIndex].element.classList.remove('active');
        }

        lyricsState.currentIndex = index;

        if (index >= 0 && lyricsState.cues[index]) {
            const lineEl = lyricsState.cues[index].element;
            lineEl.classList.add('active');
            scrollLyricsIntoView(lineEl, ui.scroll);
        }
    }

    function scrollLyricsIntoView(lineEl, container) {
        if (!container || !lineEl) return;
        const lineTop = lineEl.offsetTop;
        const lineBottom = lineTop + lineEl.offsetHeight;
        const viewTop = container.scrollTop;
        const viewBottom = viewTop + container.clientHeight;

        if (lineTop < viewTop) {
            const target = Math.max(lineTop - 12, 0);
            if (typeof container.scrollTo === 'function') {
                container.scrollTo({ top: target, behavior: 'smooth' });
            } else {
                container.scrollTop = target;
            }
        } else if (lineBottom > viewBottom) {
            const target = lineBottom - container.clientHeight + 12;
            if (typeof container.scrollTo === 'function') {
                container.scrollTo({ top: target, behavior: 'smooth' });
            } else {
                container.scrollTop = target;
            }
        }
    }

    function handleGlobalHotkeys(event) {
        const keyLower = event.key && event.key.toLowerCase ? event.key.toLowerCase() : event.key;
        if (event.ctrlKey && event.altKey && keyLower === 'c') {
            event.preventDefault();
            toggleCRT();
            return;
        }
        if (event.ctrlKey && event.altKey && keyLower === 'p') {
            event.preventDefault();
            clickSound.play();
            const alreadyOpen = !!openWindows['XP Tips'];
            openWindow('XP Tips', 'XP', 160, 110);
            if (!alreadyOpen) {
                announceDesktopMessage('XP Tips unlocked. Press X -> P -> ! anytime.');
            }
            return;
        }
        if (event.ctrlKey || event.altKey || event.metaKey) {
            secretSequenceProgress = 0;
            return;
        }
        const key = event.key.length === 1 ? event.key.toLowerCase() : event.key;
        const expected = SECRET_SEQUENCE[secretSequenceProgress];
        const expectedNormalized = expected.length === 1 ? expected.toLowerCase() : expected;
        if (key === expectedNormalized) {
            secretSequenceProgress++;
            if (secretSequenceProgress === SECRET_SEQUENCE.length) {
                secretSequenceProgress = 0;
                const alreadyOpen = !!openWindows['XP Tips'];
                openWindow('XP Tips', 'XP', 160, 110);
                if (!alreadyOpen) {
                    announceDesktopMessage('XP Tips unlocked. Press Ctrl+Alt+C to toggle CRT bloom.');
                }
            }
        } else {
            const firstNormalized = SECRET_SEQUENCE[0].length === 1 ? SECRET_SEQUENCE[0].toLowerCase() : SECRET_SEQUENCE[0];
            secretSequenceProgress = key === firstNormalized ? 1 : 0;
        }
    }
    
    document.addEventListener('keydown', handleGlobalHotkeys);
    
    // --- "You Are An Idiot" Virus Logic ---
    let idiotWindows = [];
    
    function triggerIdiotVirus() {
        if (idiotWindows.length > 0) return;

        for (let i = 0; i < 9; i++) {
            createIdiotWindow();
        }

        setTimeout(() => {
            idiotWindows.forEach(win => {
                if (win.parentNode) {
                    win.parentNode.removeChild(win);
                }
            });
            idiotWindows = [];
        }, 15000);
    }

    function createIdiotWindow() {
        zIndexCounter++;
        const win = document.createElement('div');
        win.className = 'idiot-window';
        win.style.zIndex = zIndexCounter;
        win.innerHTML = `
            <div class="idiot-window-content">bouncing skull virus 2025 no virus 😱😱</div>
            <img src="skull.gif" alt="skull" style="width: 64px; height: 64px; margin-top: 10px;">
        `;
        
        desktop.appendChild(win);
        
        const rect = desktop.getBoundingClientRect();
        
        let pos = {
            x: Math.random() * (rect.width - 300),
            y: Math.random() * (rect.height - 200 - 28)
        };
        let vel = {
            x: (Math.random() > 0.5 ? 1 : -1) * (Math.random() * 2 + 1),
            y: (Math.random() > 0.5 ? 1 : -1) * (Math.random() * 2 + 1)
        };
        
        win.style.left = pos.x + 'px';
        win.style.top = pos.y + 'px';

        const move = () => {
            if (!win.parentNode) return;

            pos.x += vel.x;
            pos.y += vel.y;

            if (pos.x <= 0 || pos.x >= rect.width - 300) vel.x *= -1;
            if (pos.y <= 0 || pos.y >= rect.height - 200 - 28) vel.y *= -1;

            win.style.left = pos.x + 'px';
            win.style.top = pos.y + 'px';

            requestAnimationFrame(move);
        };
        
        move();
        idiotWindows.push(win);
    }
    
    // Make window titlebars trigger drag
    document.addEventListener('mousedown', (e) => {
      const titlebar = e.target.closest('.window-titlebar');
      if (titlebar) {
        dragStart(e, titlebar.parentNode);
      }
    });

    // --- Calculator Logic ---
    let calcState = {
        displayValue: '0',
        firstOperand: null,
        operator: null,
        waitingForSecondOperand: false
    };

    function updateCalculatorDisplay() {
        document.getElementById('calculator-display').textContent = calcState.displayValue;
    }

    function handleCalculatorInput(input) {
        const { displayValue, waitingForSecondOperand } = calcState;

        if (input === 'C') {
            calcState = { displayValue: '0', firstOperand: null, operator: null, waitingForSecondOperand: false };
        } else if (input === '=') {
            if (calcState.operator && calcState.firstOperand !== null) {
                const result = operate(calcState.firstOperand, calcState.operator, parseFloat(displayValue));
                calcState.displayValue = `${result}`;
                calcState.firstOperand = null;
                calcState.operator = null;
                calcState.waitingForSecondOperand = true;
            }
        } else if (['+', '-', '*', '/'].includes(input)) {
            const inputValue = parseFloat(displayValue);

            if (calcState.operator && waitingForSecondOperand) {
                calcState.operator = input;
                return;
            }

            if (calcState.firstOperand === null) {
                calcState.firstOperand = inputValue;
            } else if (calcState.operator) {
                const result = operate(calcState.firstOperand, calcState.operator, inputValue);
                calcState.displayValue = `${result}`;
                calcState.firstOperand = result;
            }
            calcState.waitingForSecondOperand = true;
            calcState.operator = input;
        } else if (input === '.') {
            if (waitingForSecondOperand) {
                calcState.displayValue = '0.';
                calcState.waitingForSecondOperand = false;
            } else if (!displayValue.includes('.')) {
                calcState.displayValue += '.';
            }
        } else {
            if (waitingForSecondOperand) {
                calcState.displayValue = input;
                calcState.waitingForSecondOperand = false;
            } else {
                calcState.displayValue = displayValue === '0' ? input : displayValue + input;
            }
        }
        updateCalculatorDisplay();
    }

    function operate(a, op, b) {
        if (op === '+') return a + b;
        if (op === '-') return a - b;
        if (op === '*') return a * b;
        if (op === '/') return a / b;
    }
    
    // --- Minesweeper Logic ---
    const MINESWEEPER_BOARD_SIZE = 10;
    const MINESWEEPER_MINE_COUNT = 15;
    let minesweeperBoard = [];
    let minesweeperGameover = false;
    let minesweeperFlagsPlaced = 0;
    let minesweeperTimerSeconds = 0;
    let minesweeperTimerInterval = null;
    let minesweeperStarted = false;
    const MINESWEEPER_FACES = {
        neutral: ':)',
        dead: 'X(',
        cool: 'B)'
    };

    const MINESWEEPER_FACE_LABELS = {
        neutral: 'Start a new game',
        dead: 'Game over',
        cool: 'Minefield cleared'
    };


    function formatCounter(value) {
        const clamped = Math.max(-99, Math.min(999, value));
        if (clamped < 0) {
            const digits = Math.abs(clamped).toString().padStart(2, '0');
            return `-${digits}`;
        }
        return Math.abs(clamped).toString().padStart(3, '0');
    }

    function updateMineCounter() {
        const el = document.getElementById('minesweeper-mine-counter');
        if (!el) return;
        const remaining = MINESWEEPER_MINE_COUNT - minesweeperFlagsPlaced;
        el.textContent = formatCounter(remaining);
    }

    function updateTimerDisplay() {
        const el = document.getElementById('minesweeper-timer');
        if (!el) return;
        el.textContent = formatCounter(minesweeperTimerSeconds);
    }

    function setMinesweeperFace(state) {
        const btn = document.getElementById('minesweeper-reset-button');
        if (!btn) return;
        const glyph = MINESWEEPER_FACES[state] || MINESWEEPER_FACES.neutral;
        btn.dataset.face = state;
        btn.dataset.faceGlyph = glyph;
        const label = MINESWEEPER_FACE_LABELS[state] || MINESWEEPER_FACE_LABELS.neutral;
        btn.setAttribute('aria-label', label);
        btn.setAttribute('title', label);
    }


    function startMinesweeperTimer() {
        if (minesweeperStarted) return;
        minesweeperStarted = true;
        minesweeperTimerInterval = setInterval(() => {
            if (minesweeperGameover) return;
            minesweeperTimerSeconds = Math.min(999, minesweeperTimerSeconds + 1);
            updateTimerDisplay();
        }, 1000);
    }

    function stopMinesweeperTimer() {
        if (minesweeperTimerInterval) {
            clearInterval(minesweeperTimerInterval);
            minesweeperTimerInterval = null;
        }
        minesweeperStarted = false;
    }

    function resetMinesweeper() {
        initializeMinesweeper();
    }


    function initializeMinesweeper() {
        setMinesweeperFace('neutral');
        const grid = document.getElementById('minesweeper-grid');
        if (!grid) return;

        if (!grid.dataset.bound) {
            grid.addEventListener('click', handleMinesweeperClick);
            grid.addEventListener('contextmenu', handleMinesweeperRightClick);
            grid.dataset.bound = 'true';
        }

        stopMinesweeperTimer();
        minesweeperBoard = [];
        minesweeperGameover = false;
        minesweeperFlagsPlaced = 0;
        minesweeperTimerSeconds = 0;
        minesweeperStarted = false;
        updateMineCounter();
        updateTimerDisplay();

        grid.innerHTML = '';

        for (let i = 0; i < MINESWEEPER_BOARD_SIZE * MINESWEEPER_BOARD_SIZE; i++) {
            const cell = document.createElement('div');
            cell.className = 'minesweeper-cell';
            cell.dataset.index = i;
            grid.appendChild(cell);
            minesweeperBoard.push({
                isMine: false,
                isRevealed: false,
                isFlagged: false,
                neighborMines: 0
            });
        }
        
        let minesPlaced = 0;
        while (minesPlaced < MINESWEEPER_MINE_COUNT) {
            const randomIndex = Math.floor(Math.random() * minesweeperBoard.length);
            if (!minesweeperBoard[randomIndex].isMine) {
                minesweeperBoard[randomIndex].isMine = true;
                minesPlaced++;
            }
        }
        
        for (let i = 0; i < minesweeperBoard.length; i++) {
            if (!minesweeperBoard[i].isMine) {
                minesweeperBoard[i].neighborMines = countNeighborMines(i);
            }
        }
    }
    
    function handleMinesweeperClick(e) {
        if (minesweeperGameover) return;
        const cellEl = e.target.closest('.minesweeper-cell');
        if (!cellEl) return;
        
        const index = parseInt(cellEl.dataset.index);
        const cellData = minesweeperBoard[index];

        if (cellData.isFlagged || cellData.isRevealed) {
            return;
        }

        if (!minesweeperStarted) {
            startMinesweeperTimer();
        }

        if (cellData.isMine) {
            cellEl.classList.add('revealed');
            cellEl.innerHTML = `<img src="mine.png">`;
            minesweeperGameover = true;
            setMinesweeperFace('dead');
            stopMinesweeperTimer();
            revealAllMines();
            updateMineCounter();
        } else {
            revealCell(index);
            checkWinCondition();
        }
    }
    
    function handleMinesweeperRightClick(e) {
        e.preventDefault();
        if (minesweeperGameover) return;
        const cellEl = e.target.closest('.minesweeper-cell');
        if (!cellEl) return;
        
        const index = parseInt(cellEl.dataset.index);
        const cellData = minesweeperBoard[index];
        
        if (cellData.isRevealed) return;
        
        if (cellData.isFlagged) {
            cellData.isFlagged = false;
            cellEl.innerHTML = '';
            minesweeperFlagsPlaced -= 1;
        } else {
            cellData.isFlagged = true;
            cellEl.innerHTML = `<img src="flag.png">`;
            minesweeperFlagsPlaced += 1;
        }
        updateMineCounter();
        checkWinCondition();
    }
    
    function getNeighbors(index) {
        const neighbors = [];
        const row = Math.floor(index / MINESWEEPER_BOARD_SIZE);
        const col = index % MINESWEEPER_BOARD_SIZE;
        
        for (let i = -1; i <= 1; i++) {
            for (let j = -1; j <= 1; j++) {
                if (i === 0 && j === 0) continue;
                const newRow = row + i;
                const newCol = col + j;
                
                if (newRow >= 0 && newRow < MINESWEEPER_BOARD_SIZE && newCol >= 0 && newCol < MINESWEEPER_BOARD_SIZE) {
                    const newIndex = newRow * MINESWEEPER_BOARD_SIZE + newCol;
                    neighbors.push(newIndex);
                }
            }
        }
        return neighbors;
    }
    
    function countNeighborMines(index) {
        let count = 0;
        const neighbors = getNeighbors(index);
        neighbors.forEach(neighborIndex => {
            if (minesweeperBoard[neighborIndex].isMine) {
                count++;
            }
        });
        return count;
    }
    
    function revealCell(index) {
        const cellData = minesweeperBoard[index];
        const cellEl = document.querySelector(`.minesweeper-cell[data-index="${index}"]`);
        
        if (cellData.isRevealed || cellData.isFlagged) return;
        
        cellData.isRevealed = true;
        cellEl.classList.add('revealed');
        
        if (cellData.neighborMines > 0) {
            cellEl.textContent = cellData.neighborMines;
            cellEl.classList.add(`number-${cellData.neighborMines}`);
        } else {
            const neighbors = getNeighbors(index);
            neighbors.forEach(neighborIndex => {
                revealCell(neighborIndex);
            });
        }
    }
    
    function revealAllMines() {
        minesweeperBoard.forEach((cell, index) => {
            if (cell.isMine) {
                const cellEl = document.querySelector(`.minesweeper-cell[data-index="${index}"]`);
                cellEl.classList.add('revealed');
                if (!cell.isFlagged) {
                    cellEl.innerHTML = `<img src="mine.png">`;
                }
            }
        });
    }

    function checkWinCondition() {
        let revealedCount = 0;
        let correctlyFlagged = 0;
        minesweeperBoard.forEach(cell => {
            if (cell.isRevealed) {
                revealedCount++;
            }
            if (cell.isFlagged && cell.isMine) {
                correctlyFlagged++;
            }
        });

        let playerWon = false;

        if (revealedCount === (MINESWEEPER_BOARD_SIZE * MINESWEEPER_BOARD_SIZE) - MINESWEEPER_MINE_COUNT) {
            minesweeperGameover = true;
            playerWon = true;
        } else if (correctlyFlagged === MINESWEEPER_MINE_COUNT) {
            let allMinesFlagged = true;
            let hasWrongFlags = false;
            minesweeperBoard.forEach(cell => {
                if (cell.isMine && !cell.isFlagged) {
                    allMinesFlagged = false;
                }
                if (!cell.isMine && cell.isFlagged) {
                    hasWrongFlags = true;
                }
            });
            if (allMinesFlagged && !hasWrongFlags) {
                minesweeperGameover = true;
                playerWon = true;
            }
        }

        if (playerWon) {
            stopMinesweeperTimer();
            setMinesweeperFace('cool');
            updateMineCounter();
        }
    }


  </script>
</body>
</html>
